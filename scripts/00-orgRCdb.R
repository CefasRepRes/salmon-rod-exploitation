# script to organise rod catch database -----------------------------------

## a script `sourced` by the .Rmd to organise the data for the analysis.


# info --------------------------------------------------------------------

## use changelog
# snippet changelog

## use snippets for todos
# snippet todo-bug
# snippet todo-check-me
# snippet todo-document-me
# snippet todo-fix-me
# snippet todo-optimise-me
# snippet todo-test-me

# use snippets for code chunks
# snippet saveplot
# snippet loadlatestdata


# change log --------------------------------------------------------------

## changelog
##! CHANGE LOG: (20220718 15:30:17) Substituted "Data" in here() for data.dir, and re-ran using RCdb from 1994-2020


# additional libraries ----------------------------------------------------


# additional setup --------------------------------------------------------


# licence database data ---------------------------------------------------

## organise files exported from MS Access
f_nms <- list.files(path = here(data_dir, "EALicenceDB"), 
                    pattern = "^tbl[A-Z,a-z]*_[0-9]*.txt$")

## combine all tblBandSalmon and tblBandSeaTrout
foo <- paste0(here(data_dir, "EALicenceDB"), "/", grep("tblBandSalmon", f_nms, value = TRUE))
fee <- lapply(foo, read.csv, stringsAsFactors = FALSE)
BandSalmon <- unique(rbindlist(fee))
foo <- paste0(here(data_dir, "EALicenceDB"), "/", grep("tblBandSeaTrout", f_nms, value = TRUE))
fee <- lapply(foo, read.csv, stringsAsFactors = FALSE)
BandSeaTrout <- unique(rbindlist(fee))
# Q: these bands seem to change from one scheme in 1994-1997 to another in 1998-2017; do I need to worry about these?
# A: Do not worry about it - it is for catch stats tables. We only need to worry about this if we think it is important to consider size of fish exploited, which would be important for egg deposition

## remove tblBandSalmon and tblBandSeaTrout files from list
f_nms <- grep("tblBandS", f_nms, value = TRUE, invert = TRUE)

# MS Access database changes through time: see the "Relationship_report_*.pdf" files in EALicenceDB/
# It seems that the Tables used in 1994-2013 are:
#  + tblLicence
#  + tblLicenceType
#  + tblRiver
#  + tblFish
#  + tblCatchEffort
#  + tblCatchment
#  + tblSpecies
# It seems that the Tables used in 2014-2017 are:
#  + tblLicence
#  + tblLicenceType
#  + tblRiver
#  + tblFish
#  + tblYear
#  + tblRiversFished
#  + tblSpecies


## read data tables exported from MS Access

## period 1994-2013
yrs_ <- as.character(1994:2013)
foo <- grep(paste0(yrs_, collapse = "|"), f_nms, value = TRUE)

# tables
#  + tblLicence
#  + tblLicenceType
#  + tblRiver
#  + tblFish
#  + tblCatchEffort
#  + tblCatchment
#  + tblSpecies

## remove tables that are not in relationship reports: "tblLicenceReturns", "tblYear"
foo <- grep("tblLicenceReturns|tblYear", foo, value = TRUE, invert = TRUE)

## remove other tables that are not required: "tblLicenceType", "tblSpecies"
foo <- grep("tblLicenceType|tblSpecies", foo, value = TRUE, invert = TRUE)

## split by year
fee <- data.frame(do.call("rbind", strsplit(gsub(".txt", "", foo), "_")))
fee$f <- foo
foo <- split(fee, fee$X2)

## read data in year loop
for (y in yrs_) {
  
  ### read tables
  for (f in foo[[y]]$f) {
    fii <- read.csv(here(data_dir, "EALicenceDB/", f), stringsAsFactors = FALSE)
    assign(gsub("^tbl([A-Z, a-z]*)_[0-9]*.txt$", "\\1", f), fii)
  }
  
  ### FIX: Year in 2006 CatchEffort and Licence is 2000!
  if (y == "2006") {
    CatchEffort$Year <- 2006
    Licence$Year <- 2006
  }
  
  ### re-assemble data into single long database
  
  ### merge Fish and CatchEffort
  dat <- merge(x = CatchEffort, y = Fish, 
               by = "CatchEffortID", all = TRUE)
  
  ### add Licence
  dat <- merge(x = dat, y = Licence[, -which(colnames(Licence) == "Year")], 
               by = "LicenceID", all = TRUE)
  
  ### add River
  dat <- merge(x = dat, y = River, 
               by = "RiverID", all = TRUE)
  
  ### add Catchment
  dat <- merge(x = dat, y = Catchment, 
               by = "CatchmentID", all = TRUE)
  
  ### remove periods (".") from column names
  colnames(dat) <- gsub("\\.", "", colnames(dat))
  
  ### replace in foo
  foo[[y]] <- dat
  
  ### end of year loop
}

## combine into a single data.table
dat <- rbindlist(foo, fill = TRUE)

## save dat
assign(paste0("dat_", paste0(yrs_[c(1, length(yrs_))], collapse = "_")), dat)


## period 2014-2017
yrs_ <- as.character(2014:2017)
foo <- grep(paste0(yrs_, collapse = "|"), f_nms, value = TRUE)

# tables
#  + tblLicence
#  + tblLicenceType
#  + tblRiver
#  + tblFish
#  + tblYear
#  + tblRiversFished
#  + tblSpecies

## remove tables that are not in relationship reports: "tblOnlineRiverCorrection", "tblOnlineRiverCorrectionsMultiname"
foo <- grep("tblOnlineRiverCorrection", foo, value = TRUE, invert = TRUE)

## remove other tables that are not required: "tblLicenceType", "tblSpecies", "tblCatchEffort", "tblMethod", "tblYear"
foo <- grep("tblCatchEffort|tblLicenceType|tblSpecies|tblMethod|tblYear", foo, value = TRUE, invert = TRUE)

## split by year
fee <- data.frame(do.call("rbind", strsplit(gsub(".txt", "", foo), "_")))
fee$f <- foo
foo <- split(fee, fee$X2)

## read data in year loop
for (y in yrs_) {
  
  ### read tables
  for (f in foo[[y]]$f) {
    fii <- read.csv(here(data_dir, "EALicenceDB/", f), stringsAsFactors = FALSE)
    assign(gsub("^tbl([A-Z, a-z]*)_[0-9]*.txt$", "\\1", f), fii)
  }
  
  ### FIX: "CatchEfforID" to "CatchEffortID" in RiversFished
  idx <- which(colnames(RiversFished) == "CatchEfforID")
  if (length(idx) > 0) colnames(RiversFished)[idx] <- "CatchEffortID"
  
  ### re-assemble data into single long database
  
  ### merge Fish and RiversFished
  dat <- merge(x = RiversFished[, -which(colnames(RiversFished) %in% c("Electronic_Download", "DidNotFish"))],
               y = Fish, 
               by = "CatchEffortID", all = TRUE)
  
  ### add Licence
  dat <- merge(x = dat, y = Licence[, -which(colnames(Licence) %in% c("Year", "Electronic_Download"))], 
               by = "LicenceID", all = TRUE)
  
  ### add River
  dat <- merge(x = dat, y = River, 
               by = "RiverID", all = TRUE)
  
  ### remove periods (".") from column names
  colnames(dat) <- gsub("\\.", "", colnames(dat))
  
  ### replace in foo
  foo[[y]] <- dat
  
  ### end of year loop
}

## FIX: "DidNotFish1" in 2016 and 2017 has no data - remove
foo[["2016"]] <- foo[["2016"]][, -which(colnames(foo[["2016"]]) == "DidNotFish1")]
foo[["2017"]] <- foo[["2017"]][, -which(colnames(foo[["2017"]]) == "DidNotFish1")]

## FIX: FishingDays, FishingDaysAfter15th & FishingDaysBefore16th
### see emails with IanD entitled "Fishing effort" starting Fri 2021-03-12 16:49
### 2014
foo[["2014"]]$FishingDays <- ifelse(is.na(foo[["2014"]]$FishingDays), 
                                    0, foo[["2014"]]$FishingDays)
foo[["2014"]]$FishingDaysAfter15th <- foo[["2014"]]$FishingDays
foo[["2014"]]$FishingDays <- foo[["2014"]]$FishingDaysBefore16th + foo[["2014"]]$FishingDaysAfter15th
### 2015
foo[["2015"]]$FishingDaysAfter15th <- foo[["2015"]]$FishingDays
foo[["2015"]]$FishingDays <- foo[["2015"]]$FishingDaysBefore16th + foo[["2015"]]$FishingDaysAfter15th
### 2016
foo[["2016"]]$FishingDaysAfter15th <- foo[["2016"]]$FishingDays
foo[["2016"]]$FishingDays <- foo[["2016"]]$FishingDaysBefore16th + foo[["2016"]]$FishingDaysAfter15th
### 2017
foo[["2017"]]$FishingDays <- foo[["2017"]]$FishingDaysBefore16th + foo[["2017"]]$FishingDaysAfter15th

## combine into a single data.table
dat <- rbindlist(foo, fill = TRUE)

## save dat
assign(paste0("dat_", paste0(yrs_[c(1, length(yrs_))], collapse = "_")), dat)

## fix columns in data from both periods
setnames(dat_2014_2017, "Catchment", "CatchmentName")
rm_cols <- c("Postcode", "NearestTown", "County")
dat_2014_2017[, rm_cols] <- NULL
rm_cols <- c("Postcode")
dat_1994_2013[, rm_cols] <- NULL
add_cols <- c("DidNotFish", 
              "Electronic_Download",
              "Fished_Before_16th", "FishingDaysAfter15th", "FishingDaysBefore16th",
              "KG_Weight",
              "Small_Trout")
dat_1994_2013[, add_cols] <- NA

## combine data from both periods
cols <- colnames(dat_1994_2013)
setcolorder(dat_2014_2017, cols)
dat <- rbind(dat_1994_2013, dat_2014_2017)

## fix Released; suppress warning when using NA probability
### see C:/Users/SG14/Completed/RodExploitation/Documentation/Combining_and_correcting_EA_rodcatchdatabases_1994to2020_v1.Rmd 
dat[, "Released"] <- suppressWarnings(rbinom(n = nrow(dat), 
                                             size = 1, 
                                             prob = dat$Released))

## fix Method; 1 = "Fly", 2 = "Spinner", 3 = "Bait", 4 = "Unknown", NA
dat[, "Method"] <- factor(dat$Method,
                          levels = 1:4,
                          labels = c("Fly", "Spinner", "Bait", "Unknown"))
idx <- which(!is.na(dat$SpeciesID) & is.na(dat$Method))
dat[idx, Method := "Unknown"]

## fix column classes
dat_cls <- c("CatchmentID" = "character", "RiverID" = "character", 
             "LicenceID" = "character", "CatchEffortID" = "character",
             "Year" = "integer", 
             "FishingDays" = "integer", "FishingDaysNull" = "integer", 
             "CatchID" = "character", 
             "CaptureDate" = "character",
             "DayNull" = "integer", "DateNull" = "integer",
             "SpeciesID" = "character",
             "DecimalPounds" = "numeric", "Pounds" = "numeric", "Ounces" = "numeric",
             "Method" = "character", "Released" = "integer",
             "LicenceTypeID" = "character", 
             "RiverName" = "character", 
             "Region" = "character", "CatchmentName" = "character", 
             "DidNotFish" = "integer", "Electronic_Download" = "integer",
             "Fished_Before_16th" = "integer", 
             "FishingDaysAfter15th" = "integer",
             "FishingDaysBefore16th" = "integer", 
             "KG_Weight" = "numeric", "Small_Trout" = "numeric")
for (i in colnames(dat)) {
  f <- get(paste0("as.", dat_cls[i]))
  set(dat, j = i, value = f(dat[[i]]))
}

## remove unusual years
idx <- which(!dat$Year %in% 1990:2017)
if (length(idx) > 0) {
  dat <- dat[-idx, ]
}

## standardise RiverName and CatchmentName by CatchmentID
idx <- match(dat$CatchmentID, psr_catchmentids)
dat$RiverName <- names(psr_catchmentids)[idx]
dat$CatchmentName <- names(psr_catchmentids)[idx]


# add 2018+ data ----------------------------------------------------------

## data kept in new format and sent by Katie Whitlock in emails 
## entitled "RE: rod exploit data requirements" on 2020-07-27:
## - "Metadata.xlsx"
## - "2018 effort_by catchment.xlsx"
## - "2018 individual catches.xlsx"
## - "2018 salmon without effort.xlsx" (not present for 2019)
## - "2019 effort_by catchment.xlsx", 
## - "2019 individual catches.xlsx"
## and 2020-08-03:
## - "2018 effort_by_angler.xlsx" 
## - "2019 effort_by_angler.xlsx"
## and updated again by Lawrence Talks in email entitled 
## "Rod data for 2020 (prov) and 2019 (final)" on Mon 2021-03-01 11:51
## - GrilseSplit_DataAnalysis_2019final 11.02.2021.xlsx
## - GrilseSplit_DataAnalysis_2020prov 11.02.2021.xlsx
## and by Lawrence Talks in email entitled
## "FW: RCR - catch return report" on Thu 2021-03-04 09:22
## - RCR - Catch Detail Reporting Tool_with Effort tab_2019.xlsx
## - RCR - Catch Detail Reporting Tool_with Effort tab_2020.xlsx

## consolidate old and new column names
nms <- colnames(dat)
names(nms) <- c("CatchmentID", "RiverID", "Angler ID",
                "Activity ID",
                "Season", "FishingDays", "FishingDaysNull",
                "CatchID", "Capture Date",
                "Only Month Recorded", "No Date Recorded",
                "Species", 
                "Mass (lbs)", "Pounds", "Ounces", 
                "Method", "Released", 
                "LicenceTypeID", "River", "Region", "Catchment",
                "DidNotFish", "Return Type", 
                "Fished_Before_16th",
                "Days fished after 15th June #", "Days fished before 16th June #",
                "Mass (kg)", "Small_Trout")


## 2018

### 2018 individual catches
fii <- read_xlsx(here(data_dir, "2018 individual catches.xlsx"))
angler_catch_2018 <- as.data.table(fii)

### 2018 effort_by_angler
fii <- read_xlsx(here(data_dir, "2018 effort_by angler.xlsx"))
angler_effort_2018 <- as.data.table(fii)

### FIX: catchment names
fixes_2018 <- c("Avon Devon" = "Avon (Devon)", 
                "Avon Hants" = "Avon (Hants)", 
                "Duddon" = "Duddon (& Lickle)",
                "Eden North West" = "Eden (NW)",
                "Esk Border" = "Esk (Border)",
                "Esk Cumbrian" = "Esk (Cumbrian)",
                "Esk Yorkshire" = "Esk (Yorkshire)",
                "Stour (South West)" = "Stour (SW)",
                "Taff" = "Taff & Ely",
                "Wyre North West" = "Wyre (NW)")
idx <- match(angler_catch_2018$Catchment, names(fixes_2018))
angler_catch_2018[!is.na(idx), "Catchment"] <- fixes_2018[na.omit(idx)]
idx <- match(angler_effort_2018$Catchment, names(fixes_2018))
angler_effort_2018[!is.na(idx), "Catchment"] <- fixes_2018[na.omit(idx)]

### FIX: river names
angler_catch_2018$River <- angler_catch_2018$Catchment
angler_effort_2018$River <- angler_effort_2018$Catchment

### FIX: released
angler_catch_2018$Released <- as.integer(as.logical(angler_catch_2018$Released))

### add CatchmentID
idx <- match(angler_catch_2018$Catchment, names(psr_catchmentids))
angler_catch_2018$CatchmentID <- psr_catchmentids[idx]
idx <- match(angler_effort_2018$Catchment, names(psr_catchmentids))
angler_effort_2018$CatchmentID <- psr_catchmentids[idx]

### merge on Activity ID
merge_cols <- c("Activity ID", "Season", "Region", "Catchment", "River")
dat_2018 <- merge(x = angler_catch_2018, 
                  y = angler_effort_2018, 
                  by = merge_cols,
                  all = TRUE)

### populate FishingDays
fii1 <- ifelse(is.na(dat_2018$`Days fished before 16th June #`), 
               0, 
               dat_2018$`Days fished before 16th June #`)
fii2 <- ifelse(is.na(dat_2018$`Days fished after 15th June #`), 
               0, 
               dat_2018$`Days fished after 15th June #`)
dat_2018$FishingDays <- fii1 + fii2

### remove unwanted columns
idx <- na.omit(colnames(dat_2018)[match(names(nms), colnames(dat_2018))])
dat_2018 <- dat_2018[, ..idx]

### rename columns
colnames(dat_2018) <- nms[colnames(dat_2018)]

### verify column classes
for (i in colnames(dat_2018)) {
  f <- get(paste0("as.", dat_cls[i]))
  set(dat_2018, j = i, value = f(dat_2018[[i]]))
}

### add extra columns for compatibility and reorder
dat_2018[, unname(nms)[!unname(nms) %in% colnames(dat_2018)]] <- NA
setcolorder(dat_2018, colnames(dat))

## 2019

### "provisional" 2019 data from Katie
if (0) {
  
  ### 2019 individual catches
  fii <- read_xlsx(here(data_dir, "2019 individual catches.xlsx"))
  angler_catch_2019 <- as.data.table(fii)
  
  ### 2019 effort_by_angler
  fii <- read_xlsx(here(data_dir, "2019 effort_by angler.xlsx"))
  angler_effort_2019 <- as.data.table(fii)
  
  ### FIX: catchment names
  fixes_2019 <- c("Avon Devon" = "Avon (Devon)", 
                  "Avon Hants" = "Avon (Hants)", 
                  "Duddon" = "Duddon (& Lickle)",
                  "Eden North West" = "Eden (NW)",
                  "Esk Border" = "Esk (Border)",
                  "Esk Cumbrian" = "Esk (Cumbrian)",
                  "Esk Yorkshire" = "Esk (Yorkshire)",
                  "Stour (South West)" = "Stour (SW)",
                  "Taff" = "Taff & Ely",
                  "Wyre North West" = "Wyre (NW)")
  idx <- match(angler_catch_2019$Catchment, names(fixes_2019))
  angler_catch_2019[!is.na(idx), "Catchment"] <- fixes_2019[na.omit(idx)]
  idx <- match(angler_effort_2019$Catchment, names(fixes_2019))
  angler_effort_2019[!is.na(idx), "Catchment"] <- fixes_2019[na.omit(idx)]
  
  ### FIX: river names
  angler_catch_2019$River <- angler_catch_2019$Catchment
  angler_effort_2019$River <- angler_effort_2019$Catchment
  
  ### FIX: released
  angler_catch_2019$Released <- as.integer(as.logical(angler_catch_2019$Released))
  
  ### add CatchmentID
  idx <- match(angler_catch_2019$Catchment, names(psr_catchmentids))
  angler_catch_2019$CatchmentID <- psr_catchmentids[idx]
  idx <- match(angler_effort_2019$Catchment, names(psr_catchmentids))
  angler_effort_2019$CatchmentID <- psr_catchmentids[idx]
  
  ### merge on Activity ID
  merge_cols <- c("Activity ID", "Season", "Region", "Catchment", "River")
  dat_2019 <- merge(x = angler_catch_2019, 
                    y = angler_effort_2019, 
                    by = merge_cols,
                    all = TRUE)
  
  ### populate FishingDays
  fii1 <- ifelse(is.na(dat_2019$`Days fished before 16th June #`), 
                 0, 
                 dat_2019$`Days fished before 16th June #`)
  fii2 <- ifelse(is.na(dat_2019$`Days fished after 15th June #`), 
                 0, 
                 dat_2019$`Days fished after 15th June #`)
  dat_2019$FishingDays <- fii1 + fii2
  
  ### remove unwanted columns
  idx <- na.omit(colnames(dat_2019)[match(names(nms), colnames(dat_2019))])
  dat_2019 <- dat_2019[, ..idx]
  
  ### rename columns
  colnames(dat_2019) <- nms[colnames(dat_2019)]
  
  ### verify column classes
  for (i in colnames(dat_2019)) {
    f <- get(paste0("as.", dat_cls[i]))
    set(dat_2019, j = i, value = f(dat_2019[[i]]))
  }
  
  ### add extra columns for compatibility and reorder
  dat_2019[, unname(nms)[!unname(nms) %in% colnames(dat_2019)]] <- NA
  setcolorder(dat_2019, colnames(dat))
  
}

### "final" 2019 data from Lawrence
if (1) {
  
  ### 2019 individual catches
  fii <- read_xlsx(here(data_dir, "GrilseSplit_DataAnalysis_2019final 11.02.2021.xlsx"),
                   sheet = "Individual catch data 2019final")
  ### fix date
  fii$`Capture Date` <- as.character(as.Date(fii$`Capture Date`, 
                                             origin = as.Date("1899-12-30")))
  angler_catch_2019 <- as.data.table(fii)
  
  ### 2019 effort_by_angler
  fii <- read_xlsx(here(data_dir, "RCR - Catch Detail Reporting Tool_with Effort tab_2019.xlsx"))
  angler_effort_2019 <- as.data.table(fii)
  
  ### FIX: catchment names
  fixes_2019 <- c("Avon Devon" = "Avon (Devon)", 
                  "Avon Hants" = "Avon (Hants)", 
                  "Duddon" = "Duddon (& Lickle)",
                  "Eden North West" = "Eden (NW)",
                  "Esk Border" = "Esk (Border)",
                  "Esk Cumbrian" = "Esk (Cumbrian)",
                  "Esk Yorkshire" = "Esk (Yorkshire)",
                  "Stour (South West)" = "Stour (SW)",
                  "Taff" = "Taff & Ely",
                  "Wyre North West" = "Wyre (NW)")
  idx <- match(angler_catch_2019$Catchment, names(fixes_2019))
  angler_catch_2019[!is.na(idx), "Catchment"] <- fixes_2019[na.omit(idx)]
  idx <- match(angler_effort_2019$Catchment, names(fixes_2019))
  angler_effort_2019[!is.na(idx), "Catchment"] <- fixes_2019[na.omit(idx)]
  
  ## FIX: river names
  angler_catch_2019$River <- angler_catch_2019$Catchment
  angler_effort_2019$River <- angler_effort_2019$Catchment
  
  ## FIX: released
  angler_catch_2019$Released <- as.integer(as.logical(angler_catch_2019$Released))
  
  ### add CatchmentID
  idx <- match(angler_catch_2019$Catchment, names(psr_catchmentids))
  angler_catch_2019$CatchmentID <- psr_catchmentids[idx]
  idx <- match(angler_effort_2019$Catchment, names(psr_catchmentids))
  angler_effort_2019$CatchmentID <- psr_catchmentids[idx]
  
  ### merge on Activity ID
  merge_cols <- c("Activity ID", "Season", "Region", "Catchment", "River")
  dat_2019 <- merge(x = angler_catch_2019,
                    y = angler_effort_2019,
                    by = merge_cols,
                    all = TRUE)
  
  ### populate FishingDays
  fii1 <- ifelse(is.na(dat_2019$`Days fished before 16th June #`), 
                 0, 
                 dat_2019$`Days fished before 16th June #`)
  fii2 <- ifelse(is.na(dat_2019$`Days fished after 15th June #`), 
                 0, 
                 dat_2019$`Days fished after 15th June #`)
  dat_2019$FishingDays <- fii1 + fii2
  
  ### remove unwanted columns
  idx <- na.omit(colnames(dat_2019)[match(names(nms), colnames(dat_2019))])
  dat_2019 <- dat_2019[, ..idx]
  
  ### rename columns
  colnames(dat_2019) <- nms[colnames(dat_2019)]
  
  ### verify column classes
  for (i in colnames(dat_2019)) {
    f <- get(paste0("as.", dat_cls[i]))
    set(dat_2019, j = i, value = f(dat_2019[[i]]))
  }
  
  ### add extra columns for compatibility and reorder
  dat_2019[, unname(nms)[!unname(nms) %in% colnames(dat_2019)]] <- NA
  setcolorder(dat_2019, colnames(dat))
  
}

## 2020

### 2020 individual catches
fii <- read_xlsx(here(data_dir, "GrilseSplit_DataAnalysis_2020final 03.03.2022.xlsx"),
                 sheet = "Individual catch data 2020")
angler_catch_2020 <- as.data.table(fii)

### 2020 effort_by_angler
fii <- read_xlsx(here(data_dir, "RCR - Catch Detail Reporting Tool_with Effort tab_2020_02032022.xlsx"))
angler_effort_2020 <- as.data.table(fii)

### FIX: catchment names
fixes_2020 <- c("Avon Devon" = "Avon (Devon)", 
                "Avon Hants" = "Avon (Hants)", 
                "Duddon" = "Duddon (& Lickle)",
                "Eden North West" = "Eden (NW)",
                "Esk Border" = "Esk (Border)",
                "Esk Cumbrian" = "Esk (Cumbrian)",
                "Esk Yorkshire" = "Esk (Yorkshire)",
                "Stour (South West)" = "Stour (SW)",
                "Taff" = "Taff & Ely",
                "Wyre North West" = "Wyre (NW)")
idx <- match(angler_catch_2020$Catchment, names(fixes_2020))
angler_catch_2020[!is.na(idx), "Catchment"] <- fixes_2020[na.omit(idx)]
idx <- match(angler_effort_2020$Catchment, names(fixes_2020))
angler_effort_2020[!is.na(idx), "Catchment"] <- fixes_2020[na.omit(idx)]

### FIX: river names
angler_catch_2020$River <- angler_catch_2020$Catchment
angler_effort_2020$River <- angler_effort_2020$Catchment

### FIX: released
angler_catch_2020$Released <- as.integer(as.logical(angler_catch_2020$Released))

### add CatchmentID
idx <- match(angler_catch_2020$Catchment, names(psr_catchmentids))
angler_catch_2020$CatchmentID <- psr_catchmentids[idx]
idx <- match(angler_effort_2020$Catchment, names(psr_catchmentids))
angler_effort_2020$CatchmentID <- psr_catchmentids[idx]

### merge on Activity ID
merge_cols <- c("Activity ID", "Season", "Region", "Catchment", "River")
dat_2020 <- merge(x = angler_catch_2020,
                  y = angler_effort_2020,
                  by = merge_cols,
                  all = TRUE)

### populate FishingDays
fii1 <- ifelse(is.na(dat_2020$`Days fished before 16th June #`), 
               0, 
               dat_2020$`Days fished before 16th June #`)
fii2 <- ifelse(is.na(dat_2020$`Days fished after 15th June #`), 
               0, 
               dat_2020$`Days fished after 15th June #`)
dat_2020$FishingDays <- fii1 + fii2

### remove unwanted columns
idx <- na.omit(colnames(dat_2020)[match(names(nms), colnames(dat_2020))])
dat_2020 <- dat_2020[, ..idx]

### rename columns
colnames(dat_2020) <- nms[colnames(dat_2020)]

### verify column classes
for (i in colnames(dat_2020)) {
  f <- get(paste0("as.", dat_cls[i]))
  set(dat_2020, j = i, value = f(dat_2020[[i]]))
}

### add extra columns for compatibility and reorder
dat_2020[, unname(nms)[!unname(nms) %in% colnames(dat_2020)]] <- NA
setcolorder(dat_2020, colnames(dat))


## combine & fix

## combine 2018 to 2020
dat_2018_2020 <- rbindlist(list(dat_2018, dat_2019, dat_2020))

## FIX: add CatchmentIDs for missing PSR rivers!
foo <- data.table("RiverName" = names(psr_catchmentids),
                  "CatchmentID" = as.character(psr_catchmentids))
dat_2018_2020 <- merge(x = dat_2018_2020[, !"CatchmentID"], 
                       y = foo, 
                       by = "RiverName",
                       all = TRUE)

## FIX: ensure "CaptureDate" is a character
dat_2018_2020$CaptureDate <- as.character(dat_2018_2020$CaptureDate)

## FIX: make date format consistent(ly wrong)
dat_2018_2020$CaptureDate <- gsub("(^[0-9]{4})-([0-9]{2})-([0-9]{2})",
                                  "\\3/\\2/\\1",
                                  dat_2018_2020$CaptureDate)

## FIX: "Salmon" to 1 in "SpeciesID"
dat_2018_2020$SpeciesID <- ifelse(dat_2018_2020$SpeciesID == "Salmon",
                                  1, dat_2018_2020$SpeciesID)

## FIX: convert "TRUE" and "FALSE" in "Released" to 1 and 0, resp.
idx <- which(dat_2018_2020$Released == "TRUE")
dat_2018_2020$Released[idx] <- "1"
idx <- which(dat_2018_2020$Released == "FALSE")
dat_2018_2020$Released[idx] <- "0"

## combine with dat
dat <- rbind(dat, dat_2018_2020)

## remove unusual years
idx <- which(!dat$Year %in% 1990:2020)
if (length(idx) > 0) {
  dat <- dat[-idx, ]
}


# final fixes -------------------------------------------------------------

## add river labels
idx <- match(dat$CatchmentID, psr_catchmentids)  
dat$RiverLabel <- names(psr_catchmentids[idx])


# save it out -------------------------------------------------------------

## write out dat
f_nm <- paste0("rod-license-db.RData")
save(dat, file = here(data_dir, f_nm))
