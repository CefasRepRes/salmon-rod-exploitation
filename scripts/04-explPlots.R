# exploratory plots script ------------------------------------------------

## a script `sourced` by the .Rmd to make exploratory plots.


# info --------------------------------------------------------------------

## use changelog
# snippet changelog

## use snippets for todos
# snippet todo-bug
# snippet todo-check-me
# snippet todo-document-me
# snippet todo-fix-me
# snippet todo-optimise-me
# snippet todo-test-me

# use snippets for code chunks
# snippet saveplot
# snippet loadlatestdata


# change log --------------------------------------------------------------

## changelog
##! CHANGE LOG: (20220718 16:47:08) Substituted "Data" in here() for data.dir, replaced Plots for plots (lowercase) here (and elsewhere), commented out pulse plots, and re-ran


# additional libraries ----------------------------------------------------


# additional setup --------------------------------------------------------


# data --------------------------------------------------------------------

## read data
load(here(data_dir, "all-vars-for-analysis.RData"))


# subset to only those data with expl rate --------------------------------

## subset to only those rivers and years with complete data
idx <- which(!is.na(dat_sub$ur_rse))
dat_sub_red <- dat_sub[idx, ]


# make table 1 rse river info ---------------------------------------------

## read and organise RSE data
river_locs <- read.csv(here(data_dir, "NASCO_river_locations.csv"))
river_locs$river <- as.character(river_locs$river)
river_locs$river[which(river_locs$river == "Dee (Clwyd)")] <- "Dee"
river_locs$river[which(river_locs$river == "Duddon")] <- "Duddon (& Lickle)" 
river_locs$river[which(river_locs$river == "Dyfi")] <- "Dyfi / Dovey"
river_locs$river[which(river_locs$river == "East Cleddau")] <- "Cleddau"
river_locs$river[which(river_locs$river == "Eden")] <- "Eden (NW)"
river_locs$river[which(river_locs$river == "Esk (Cumbria)")] <- "Esk (Cumbrian)"
river_locs$river[which(river_locs$river == "Stour (Dorset)")] <- "Stour (SW)"
river_locs$river[which(river_locs$river == "Taff")] <- "Taff & Ely"
river_locs$river[which(river_locs$river == "Tywi/Towy")] <- "Tywi / Towy"
river_locs$river[which(river_locs$river == "West Cleddau")] <- "Cleddau (Western)"
river_locs$river[which(river_locs$river == "Wyre")] <- "Wyre (NW)"
river_locs$river <- factor(river_locs$river)
river_locs$isRSE <- ifelse(river_locs$river %in% rse_rivers, 
                           TRUE, FALSE)
colnames(river_locs)[1] <- "RiverName"

## merge with dat_sub_red
foo <- merge(dat_sub_red, river_locs, by = c("RiverName"))

## make the table
fii <- foo[isRSE == TRUE, 
           .(Location = country[.N],
             "Latitude" = lat[.N],
             "Longitude" = long[.N],
             "River type" = RiverType[.N],
             "Fishery area (HA)" = AreaHA[.N],
             "Period" = paste0(range(Year), collapse = "-"),
             "Years" = sum(isRSE),
             "Gaps" = paste0(setdiff(seq(min(Year), max(Year)), Year), collapse = ", ")), 
           by = .(River = RiverName)]

## write it
write.csv(x = fii, file = here("rse-psr-descriptions.csv"),
          row.names = FALSE)


# raw data plots ----------------------------------------------------------

## prepare data
foo <- stack(dat_sub_red[RiverName %in% rse_rivers, ..cont_vars])
foo$RiverName <- factor(dat_sub_red[RiverName %in% rse_rivers, RiverName])
foo$Year <- dat_sub_red[RiverName %in% rse_rivers, Year]
foo$RSE <- dat_sub_red[RiverName %in% rse_rivers, RSE]

## remove "CapMethod", "BaseFlowIdx", "AreaHA" if available
foo <- foo[-which(foo$ind %in% c("CapMethod", "BaseFlowIdx", "AreaHA")), ]

## convert to human-readable names
foo$name <- factor(foo$ind, levels = cont_vars, labels = cont_nms) 

## prepare a mean representation
fii <- aggregate(values ~ Year + ind + name, foo, mean)

## plot it
raw_data_p <- ggplot(foo, aes(x = Year, y = values)) + 
  geom_line(aes(colour = RiverName), alpha = 0.5, size = 1.25) +
  geom_line(data = fii, size = 1.25) +
  geom_point(data = fii, size = 3) +
  facet_wrap(~ name, scales = "free_y") +
  xlab("Year") + 
  ylab("Explanatory variable value") +
  scale_colour_discrete(name = "River") +
  sgg(tfs = 16, lfs = 16)
rse_p <- ggplot(foo, aes(x = Year, y = RSE, colour = RiverName)) + 
  geom_line(alpha = 0.5, size = 1.25) +
  xlab("Year") + 
  ylab("Returning Stock Estimate") +
  scale_colour_discrete(name = "River") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "raw-data-lineplots.pdf"), width = 10, height = 7)
  print(raw_data_p)
  dev.off()
  jpeg(here("plots", "raw-data-lineplots.jpg"), res = 300, 
       width = (480 * 7), height = (480 * 5))
  print(raw_data_p)
  dev.off()
  cairo_pdf(here("plots", "rse-lineplots.pdf"), width = 10, height = 7)
  print(rse_p)
  dev.off()
  jpeg(here("plots", "rse-lineplots.jpg"), res = 300, 
       width = (480 * 7), height = (480 * 5))
  print(rse_p)
  dev.off()
}

## combine plots for figure
fig2 <- rse_p / raw_data_p + plot_layout(guides = "collect")
if (make_plots) {
  cairo_pdf(here("plots", "raw-data-combined-lineplots.pdf"), 
            width = 10, height = 9)
  print(fig2)
  dev.off()
  jpeg(here("plots", "raw-data-combined-lineplots.jpg"), res = 300, 
       width = (480 * 7), height = (480 * 6))
  print(fig2)
  dev.off()
}


# exploit plots -----------------------------------------------------------

## exploit ~ effort scatter
effort_scatterplot <- ggplot(dat_sub_red, aes(x = DeclSalEffHa, y = ur_rse)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), 
              se = TRUE, colour = 2) +
  ylab("Exploitation rate") +
  xlab("log10 declared salmon fishing effort by area") +
  facet_wrap(~RiverName, scales = "free_x") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "exploit-effort-scatterplot.pdf"), width = 7, height = 7)
  print(effort_scatterplot)
  dev.off()
  jpeg(here("plots", "exploit-effort-scatterplot.jpg"), res = 300, 
       width = (480 * 5), height = (480 * 5))
  print(effort_scatterplot)
  dev.off()
}

## exploit ~ successful effort scatter
successeff_scatterplot <- ggplot(dat_sub_red, aes(x = SuccessEff, y = ur_rse)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), 
              se = TRUE, colour = 2) +
  ylab("Exploitation rate") +
  xlab("Proportion of effort that yields a catch") +
  facet_wrap(~RiverName, scales = "free_x") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "exploit-successeff-scatterplot.pdf"), 
            width = 7, height = 7)
  print(successeff_scatterplot)
  dev.off()
  jpeg(here("plots", "exploit-successeff-scatterplot.jpg"), 
       res = 300, width = (480 * 5), height = (480 * 5))
  print(successeff_scatterplot)
  dev.off()
}

## exploit ~ prelease scatter
prelease_scatterplot <- ggplot(dat_sub_red, aes(x = pRelease, y = ur_rse)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), 
              se = TRUE, colour = 2) +
  ylab("Exploitation rate") +
  xlab("Proportion of salmon released") +
  facet_wrap(~RiverName, scales = "free_x") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "exploit-prelease-scatterplot.pdf"), width = 7, height = 7)
  print(prelease_scatterplot)
  dev.off()
  jpeg(here("plots", "exploit-prelease-scatterplot.jpg"), res = 300, 
       width = (480 * 5), height = (480 * 5))
  print(prelease_scatterplot)
  dev.off()
}

## exploit ~ method scatter
method_scatterplot <- ggplot(dat_sub_red, aes(x = CapMethod, y = ur_rse)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  ylab("Exploitation rate") +
  xlab("Proportion of salmon caught on fly") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "exploit-method-scatterplot.pdf"), width = 7, height = 7)
  print(method_scatterplot)
  dev.off()
  jpeg(here("plots", "exploit-method-scatterplot.jpg"), res = 300, 
       width = (480 * 5), height = (480 * 5))
  print(method_scatterplot)
  dev.off()
}

## exploit ~ mnflow scatter
mnflow_scatterplot <- ggplot(dat_sub_red, aes(x = mnflow, y = ur_rse)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), 
              se = TRUE, colour = 2) +
  ylab("Exploitation rate") +
  xlab("Standardised mean flow") +
  facet_wrap(~RiverName, scales = "free_x") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "exploit-mnflow-scatterplot.pdf"), width = 7, height = 7)
  print(mnflow_scatterplot)
  dev.off()
  jpeg(here("plots", "exploit-mnflow-scatterplot.jpg"), res = 300, 
       width = (480 * 5), height = (480 * 5))
  print(mnflow_scatterplot)
  dev.off()
}

# ## exploit ~ nearlyp scatter
# nearlyp_scatterplot <- ggplot(dat_sub_red, aes(x = nEarlyPulses, y = ur_rse)) +
#   geom_point() +
#   geom_smooth(method = "lm", se = TRUE) +
#   geom_smooth(method = "lm", formula = y ~ x + I(x^2), 
#               se = TRUE, colour = 2) +
#   ylab("Exploitation rate") +
#   xlab("Number of pulses in early half of season") +
#   facet_wrap(~RiverName, scales = "free_x") +
#   sgg(tfs = 16, lfs = 16)
# if (make_plots) {
#   cairo_pdf(here("plots", "exploit-nearlyp-scatterplot.pdf"), width = 7, height = 7)
#   print(nearlyp_scatterplot)
#   dev.off()
#   jpeg(here("plots", "exploit-nearlyp-scatterplot.jpg"), res = 300, 
#        width = (480 * 5), height = (480 * 5))
#   print(nearlyp_scatterplot)
#   dev.off()
# }

# ## exploit ~ nlatep scatter
# nlatep_scatterplot <- ggplot(dat_sub_red, aes(x = nLatePulses, y = ur_rse)) +
#   geom_point() +
#   geom_smooth(method = "lm", se = TRUE) +
#   geom_smooth(method = "lm", formula = y ~ x + I(x^2), 
#               se = TRUE, colour = 2) +
#   ylab("Exploitation rate") +
#   xlab("Number of pulses in late half of season") +
#   facet_wrap(~RiverName, scales = "free_x") +
#   sgg(tfs = 16, lfs = 16)
# if (make_plots) {
#   cairo_pdf(here("plots", "exploit-nlatep-scatterplot.pdf"), width = 7, height = 7)
#   print(nlatep_scatterplot)
#   dev.off()
#   jpeg(here("plots", "exploit-nlatep-scatterplot.jpg"), res = 300, 
#        width = (480 * 5), height = (480 * 5))
#   print(nlatep_scatterplot)
#   dev.off()
# }


# phi plots ---------------------------------------------------------

# ## phi as a function of `pRelease` : `RegulatedFlow`
# idx <- which(!is.na(dat_sub$RSE))
# bbb <- dat_sub[idx, .("Exploitation rate variation" = var(ur_rse / 100),
#                       "Mean proportion released" = mean(pRelease),
#                       "Regulated\nflow" = factor(mean(RegulatedFlow))), 
#                by  = RiverName]
# ppp <- ggplot(bbb, aes(x = `Mean proportion released`, 
#                        y = `Exploitation rate variation`, 
#                        label = RiverName)) +
#   geom_point(aes(shape = `Regulated\nflow`), size = 3) + 
#   geom_smooth(aes(linetype = `Regulated\nflow`, 
#                   group = `Regulated\nflow`), method = MASS::rlm) + 
#   geom_label(nudge_y = 0.001) + 
#   theme_minimal(base_size = 18)
# if (make_plots) {
#   cairo_pdf(here("plots", "phi-pRelRegflow-scatterplot.pdf"), width = 7, height = 7)
#   print(ppp)
#   dev.off()
#   jpeg(here("plots", "phi-pRelRegflow-scatterplot.jpg"), res = 300, 
#        width = (480 * 5), height = (480 * 5))
#   print(ppp)
#   dev.off()
# }


# rse plots ---------------------------------------------------------------

## rse ~ area scatter
area_scatterplot <- ggplot(dat_sub_red, aes(x = AreaHA, y = RSE)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  scale_x_log10() + 
  ylab("log10 returning stock estimate") +
  xlab("Fishery area") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "run-area-scatterplot.pdf"), width = 7, height = 7)
  print(area_scatterplot)
  dev.off()
  jpeg(here("plots", "run-area-scatterplot.jpg"), res = 300, 
       width = (480 * 5), height = (480 * 5))
  print(area_scatterplot)
  dev.off()
}

## rse ~ rivertype
fii <- dat_sub_red[, .(mean = mean(RSE), se = std.error(RSE, na.rm = FALSE)), by = RiverType]
rivertype_meanseplot <- ggplot(fii, aes(x = RiverType, y = mean)) + 
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.25) +
  ylab("Mean exploitation rate") +
  xlab("River type") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "run-rivertype-meanseplot.pdf"), width = 7, height = 7)
  print(rivertype_meanseplot)
  dev.off()
  jpeg(here("plots", "run-rivertype-meanseplot.jpg"), res = 300, 
       width = (480 * 5), height = (480 * 5))
  print(rivertype_meanseplot)
  dev.off()
}


# explanatory variable histograms -----------------------------------------

## prepare data
foo <- dat_sub[, .(RiverName, Year, 
                   DeclSalEffHa, SuccessEff, pRelease, mnflow, BaseFlowIdx, AreaHA)]
fii <- melt(foo, id.vars = c("RiverName", "Year"))

## make plot
expl_hists <- ggplot(fii, aes(x = value, y = ..density..)) + 
  geom_histogram() +
  facet_wrap(~ variable, scales = "free") +
  ylab("Density") +
  xlab("Value") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "dat-expl-hists.pdf"), width = 7, height = 7)
  print(expl_hists)
  dev.off()
  jpeg(here("plots", "dat-expl-hists.jpg"), res = 300, 
       width = (480 * 5), height = (480 * 5))
  print(expl_hists)
  dev.off()
}
