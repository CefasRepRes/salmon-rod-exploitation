# principle salmon river data script --------------------------------------

## a script `sourced` by the .Rmd to run organise the PSR data.


# info --------------------------------------------------------------------

## use changelog
# snippet changelog

## use snippets for todos
# snippet todo-bug
# snippet todo-check-me
# snippet todo-document-me
# snippet todo-fix-me
# snippet todo-optimise-me
# snippet todo-test-me

# use snippets for code chunks
# snippet saveplot
# snippet loadlatestdata


# change log --------------------------------------------------------------

## changelog
##! CHANGE LOG: (20220718 15:33:41) Substituted "Data" in here() for data.dir, improved rivers_p to ensure all rivers were showing, and re-ran
##! CHANGE LOG: (20221221 07:51:25) Minor change to ensure idx for unusual fishing days does not delete all data


# additional libraries ----------------------------------------------------


# additional setup --------------------------------------------------------


# PSR names and areas -----------------------------------------------------

## These data are from the latest Cefas/EA/NRW "Salmon Stocks 
## and Fisheries in England and Wales" - see
## "SalmonReport-2018-assessment_final.pdf".
## The data are from Table 26, which Katie Whitlock provided in 
## Excel xlsx

## read in data
river_dat <- read_xlsx(here(data_dir, "PSRs_Nov2019.xlsx"), 
                       range = "A8:R82",
                       col_names = c("river", "area", 
                                     "cl_100m2", "cl_eggs",
                                     "mt_eggs", "eggs_2018",
                                     paste0("cl_perc_", 2009:2018),
                                     "compl_2018", "compl_2023"))

## clean up
river_dat <- na.omit(river_dat)

## correct some names to match those in EALicenceDB
river_dat$river <- as.character(river_dat$river)
river_dat$river[which(river_dat$river == "Avon-Devon")] <- "Avon (Devon)"
river_dat$river[which(river_dat$river == "Avon-Hants")] <- "Avon (Hants)"
river_dat$river[which(river_dat$river == "Dyfi")] <- "Dyfi / Dovey"
river_dat$river[which(river_dat$river == "Dysinni")] <- "Dysynni"
river_dat$river[which(river_dat$river == "E&W Cleddau")] <- "Cleddau"
river_dat$river[which(river_dat$river == "Eden")] <- "Eden (NW)"
river_dat$river[which(river_dat$river == "Esk")] <- "Esk (Cumbrian)"
river_dat$river[which(river_dat$river == "Esk-Border [d]")] <- "Esk (Border)"
river_dat$river[which(river_dat$river == "Esk-Yorks")] <- "Esk (Yorkshire)"
river_dat$river[which(river_dat$river == "Stour")] <- "Stour (SW)"
river_dat$river[which(river_dat$river == "Tyne [c]")] <- "Tyne"
river_dat$river[which(river_dat$river == "Tywi")] <- "Tywi / Towy"
river_dat$river[which(river_dat$river == "Wyre")] <- "Wyre (NW)"
river_dat$river <- factor(river_dat$river)


# PSR locations -----------------------------------------------------------

## These data were extracted from the pdf "JurisdictionReportUK - 
## England & Wales.pdf" using code in the script
## "extract_NASCO_riverdb_data.R" which I have lost.
## I hope to remake that script in 
## "extract_river_details_from_JurisdictionReportUK-EWpdf.Rmd"

## read in list from NASCO rivers database
river_locs <- read.csv(here(data_dir, "NASCO_river_locations.csv"))

## correct some names to match those in EALicenceDB
river_locs$river <- as.character(river_locs$river)
river_locs$river[which(river_locs$river == "Dee (Clwyd)")] <- "Dee"
river_locs$river[which(river_locs$river == "Duddon")] <- "Duddon (& Lickle)" 
river_locs$river[which(river_locs$river == "Dyfi")] <- "Dyfi / Dovey"
river_locs$river[which(river_locs$river == "East Cleddau")] <- "Cleddau"
river_locs$river[which(river_locs$river == "Eden")] <- "Eden (NW)"
river_locs$river[which(river_locs$river == "Esk (Cumbria)")] <- "Esk (Cumbrian)"
river_locs$river[which(river_locs$river == "Stour (Dorset)")] <- "Stour (SW)"
river_locs$river[which(river_locs$river == "Taff")] <- "Taff & Ely"
river_locs$river[which(river_locs$river == "Tywi/Towy")] <- "Tywi / Towy"
river_locs$river[which(river_locs$river == "West Cleddau")] <- "Cleddau (Western)"
river_locs$river[which(river_locs$river == "Wyre")] <- "Wyre (NW)"
river_locs$river <- factor(river_locs$river)

## subset to rivers in Table 26
river_locs <- subset(river_locs, river %in% river_dat$river)

## identify RSE rivers
river_locs$isRSE <- ifelse(river_locs$river %in% rse_rivers, 
                           TRUE, FALSE)

## get EW outline
# if (!file.exists(here(data_dir, "gadm36_GBR_1_sp.rds"))) {
#   UK <- raster::getData("GADM", country = "GBR", level = 1)
#   system("mv gadm36_GBR_1_sp.rds Data/gadm36_GBR_1_sp.rds")
# } else {
UK <- readRDS(here(data_dir, "gadm36_GBR_1_sp.rds"))
# }
EW <- subset(UK, NAME_1 %in% c("England", "Wales"))
EW <- fortify(EW)

## map of PSRs
river_locs$group <- 1
rivers_p <- ggplot() + 
  geom_polygon(data = EW, aes(x = long, y = lat, group = group), colour = "black", fill = "white") +
  coord_map() +
  geom_point(data = river_locs, aes(x = long, y = lat, group = group), 
             pch = 20, colour = "blue", size = 5) +
  geom_label_repel(data = river_locs, 
                   aes(x = long, y = lat, label = river, fill = isRSE), 
                   size = 4, family = "Times New Roman",
                   max.overlaps = 20) +
  xlab("Longitude") +
  ylab("Latitude") + 
  scale_fill_manual(values = setNames(c("white", "gray"),
                                      levels(river_locs$isRSE))) +
  sgg(tfs = 16, lfs = 16) +
  theme(legend.position = "none")
if (make_plots) {
  cairo_pdf(here("plots", "river-locations.pdf"), 
            width = 7, height = 10)
  print(rivers_p)
  dev.off()
  jpeg(here("plots", "river-locations.jpg"), 
       res = 300, width = (480 * 5), height = (480 * 7))
  print(rivers_p)
  dev.off()
}


# RSE locations -----------------------------------------------------------

## subset to only rse rivers
rse_locs <- subset(river_locs, river %in% rse_rivers)

## map of RSE rivers
rse_p <- ggplot() + 
  geom_polygon(data = EW, aes(x = long, y = lat, group = group),
               colour = "black", fill = "white") +
  coord_map() +
  geom_point(data = rse_locs, aes(x = long, y = lat, group = group), 
             pch = 20, colour = "blue", size = 5) +
  geom_text_repel(data = rse_locs, 
                  aes(x = long, y = lat, label = river), 
                  nudge_x = 1.25, nudge_y = -0.3, 
                  size = 6, family = "Times New Roman",
                  max.overlaps = 50) +
  xlab("Longitude") +
  ylab("Latitude") + 
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "rse-river-locations.pdf"), 
            width = 7, height = 10)
  print(rse_p)
  dev.off()
  jpeg(here("plots", "rse-river-locations.jpg"), 
       res = 300, width = (480 * 5), height = (480 * 7))
  print(rse_p)
  dev.off()
}


# fix psr rod catch data --------------------------------------------------

## read in processed rod catch database
load(here(data_dir, "rod-license-db.RData"))

## subset dat to psr data
dat <- subset(dat, RiverLabel %in% river_dat$river)

## add area
river_dat$RiverLabel <- river_dat$river
if (!any(colnames(dat) == "area")) {
  dat <- merge(dat, river_dat[, c("RiverLabel", "area")], by = "RiverLabel")
}

## fix date
dat$CaptureDate <- gsub("(^[0-9]*)/([0-9]*)/([0-9][0-9][0-9][0-9]).*",
                        "\\3-\\2-\\1 00:00:00", dat$CaptureDate)
dat[, CaptureDate := fastPOSIXct(CaptureDate, 
                                 required.components = 6L, 
                                 tz = "GMT")]

## add some date info
dat$CaptureDay <- day(dat$CaptureDate)
dat$CaptureMonth <- month(dat$CaptureDate)
dat$CaptureYear <- year(dat$CaptureDate)
dat$CaptureDoY <- yday(dat$CaptureDate)

## add TotalFishingDays
## either sum of FishingDaysBefore16th and FishingDaysAfter15th 
## or FishingDays
## or the maximum of them both
fii <- ifelse(is.na(dat$FishingDaysBefore16th), 
              0, 
              dat$FishingDaysBefore16th)
fee <- ifelse(is.na(dat$FishingDaysAfter15th), 
              0,
              dat$FishingDaysAfter15th)
foo <- ifelse(is.na(dat$FishingDays),
              0, 
              dat$FishingDays)
dat$TotalFishingDays <- apply(cbind(fii + fee, foo), 1, max)

## reorder
dat <- setorder(dat, Year, LicenceID, CatchEffortID, CatchID)

## FIX: remove rows with silly years; "removed due to questionable data quality"
idx <- which(!dat$Year %in% yrs)
if (length(idx) > 0) {
  dat <- dat[-idx, ]
}

## FIX: repair and infill erroneous and missing KG_Weights
# lb_to_kg <- lm(KG_Weight ~ -1 + DecimalPounds, dat)
# dat$KG_Weight_fixed <- dat$DecimalPounds * coef(lb_to_kg)["DecimalPounds"]
# lb_to_kg_p <- ggplot(dat, aes(x = DecimalPounds)) +
#   geom_scattermore(aes(y = KG_Weight), size = 3, shape = 1) +
#   geom_scattermore(aes(y = KG_Weight_fixed), size = 2, shape = 19,
#              colour = "blue") +
#   xlab("Weight in decimal pounds (lb)") +
#   ylab("Weight in kilograms (kg)") +
#   sgg(tfs = 16, lfs = 16)
# if (make_plots) {
#   cairo_pdf(here("plots", "lb-to-kg-plot.pdf"), 
#             width = 7, height = 7)
#   print(lb_to_kg_p)
#   dev.off()
#   jpeg(here("plots", "lb-to-kg-plot.jpg"), 
#        res = 300, width = (480 * 5), height = (480 * 5))
#   print(lb_to_kg_p)
#   dev.off()
# }
## COMMENTED COZ TAKES TOO LONG TO PLOT WITH geom_points & geom_scattermore DOESN"T ALLOW FOR POINT AESTHETICS

## FIX: "Released"" is sometimes > 1; where it is, reduce it to 1
dat$Released <- as.numeric(dat$Released)
idx <- which(dat$Released %in% 2)
if (length(idx) > 0) {
  dat$Released[idx] <- 1
}

## remove any records with "TotalFishingDays" > 365
idx <- which(dat$TotalFishingDays > 365)
if (length(idx) > 0) {
  dat <- dat[-idx, ]
}

# season dates ------------------------------------------------------------

## read in season dates
season_dates <- data.frame(read_xlsx(path = here(data_dir, "River_season_dates.xlsx"), 
                                     sheet = "Data"))
season_dates <- subset(season_dates, Species == "Salmon")

## create vector of all years in dat
foo <- eval(parse(text = paste0(range(dat$Year, na.rm = TRUE), collapse = ":")))

## make data.table
season_dates_dt <- data.table(
  RiverName = season_dates$RiverName,
  SeasonStart = as.Date(paste0(rep(foo, each = nrow(season_dates)),
                               "-", season_dates$StartMonth, 
                               "-", season_dates$StartDay)),
  SeasonEnd = as.Date(paste0(rep(foo, each = nrow(season_dates)),
                             "-", season_dates$EndMonth, 
                             "-", season_dates$EndDay))
)

## add Year
season_dates_dt$Year <- year(season_dates_dt$SeasonStart)

## remove unwanted rivers
foo <- season_dates_dt[RiverName %in% dat$RiverLabel, ]

## merge in
dat[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverLabel", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat <- merge(dat, foo[, list(mykey, SeasonStart, SeasonEnd)], 
             by = "mykey", all.x = TRUE) # not "all = TRUE" 
# because of 0 catches on Piddle, Stour (SW), Wyre (NW) & Yealm
dat[, mykey := NULL]

## add season mid point
dat$SeasonMid <- dat$SeasonStart + with(dat, (SeasonEnd - SeasonStart) / 2)

## add in-season indicator
dat$inseason <- as.numeric(dat$CaptureDate >= dat$SeasonStart &
                             dat$CaptureDate <= dat$SeasonEnd)


# save out psr data -------------------------------------------------------

## write out dat
f_nm <- paste0("psr-rod-license-db.RData")
save(dat, file = here(data_dir, f_nm))
