# environmental variable preparation script -------------------------------

## a script `sourced` by the .Rmd to run prepare the environmental data.


# info --------------------------------------------------------------------

## use changelog
# snippet changelog

## use snippets for todos
# snippet todo-bug
# snippet todo-check-me
# snippet todo-document-me
# snippet todo-fix-me
# snippet todo-optimise-me
# snippet todo-test-me

# use snippets for code chunks
# snippet saveplot
# snippet loadlatestdata


# change log --------------------------------------------------------------

## changelog
##! CHANGE LOG: (20220718 16:41:52) Substituted "Data" in here() for data.dir, fixed Esk (Border).csv flow records, improved gaugingstations_p to ensure all rivers were showing, and re-ran


# additional libraries ----------------------------------------------------


# additional setup --------------------------------------------------------


# read data ---------------------------------------------------------------

## read in processed psr rod catch database
load(here(data_dir, "rcdb-vars-for-analysis.RData"))


# base flow ---------------------------------------------------------------

## read data
f_nms <- list.files(path = here(data_dir, "Flow_CEHarchive/"), 
                    pattern = ".csv$", full.names = TRUE)
foo <- lapply(f_nms, fread)

## add names
nms <- list.files(path = here(data_dir, "Flow_CEHarchive/"), 
                  pattern = ".csv$")
nms <- gsub(".csv$", "", nms)
nms <- gsub("-", "/", nms)
names(foo) <- nms

## make data.table
flow_dat_all <- rbindlist(foo, idcol = TRUE)

## remove extra columns
flow_dat <- flow_dat_all[, list(.id, date, final_flow)]

## colnames
colnames(flow_dat) <- c("RiverName", "date", "flow_m3s")

## add Date
flow_dat[, date := as.Date(date)]

## add year
flow_dat$Year <- year(flow_dat$date)

## fix data
flow_dat$RiverName <- factor(flow_dat$RiverName)

## ensure dates
srt_date <- as.Date("1994-01-01")
end_date <- as.Date("2020-12-31") # flow data end before this date, and often before the end of the 2020 fishing season
all_dates <- seq.Date(srt_date, end_date, by = "days")
d <- data.table(RiverName = rep(levels(flow_dat$RiverName), 
                                each = length(all_dates)),
                date = rep(all_dates, nlevels(flow_dat$RiverName)))
flow_dat <- flow_dat[d, on = c("RiverName", "date")]

## fix missing years
flow_dat$Year <- year(flow_dat$date) 

## standardise within river (baseflow index is measure of magnitude)
flow_dat[, flow_std := as.numeric(scale(flow_m3s)),
         by = RiverName]

## plot
flow_lplot <- ggplot(flow_dat, aes(x = date, y = flow_std, colour = RiverName)) +
  geom_line(size = 1.25) +
  xlab("Year") +
  # ylab(expression(sqrt(flow))) +
  # scale_y_sqrt() + 
  theme(legend.position = "bottom") +
  scale_color_discrete(name = "River\nname") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "flow-lineplots.pdf"), 
            width = 12, height = 10)
  print(flow_lplot)
  dev.off()
  jpeg(here("plots", "flow-lineplots.jpg"), 
       res = 300, width = (480 * 8), height = (480 * 7))
  print(flow_lplot)
  dev.off()
}


# gauging station locations -----------------------------------------------

## get nrfa catalogue
if (!file.exists(here(data_dir, "nrfa-station-catalogue.RData"))) {
  stn_cat <- data.table(catalogue())
  save(stn_cat, file = here(data_dir, "nrfa-station-catalogue.RData"))
} else {
  load(here(data_dir, "nrfa-station-catalogue.RData"))
}

## get stn_locs 
stn_locs <- stn_cat[match(psr_station_ids, id), 
                    list(id,
                         lat =latitude, 
                         long = longitude, 
                         RiverName = names(psr_station_ids))]

## add group
stn_locs$group <- 1

## get EW outline
# if (!file.exists(here(data_dir, "gadm36_GBR_1_sp.rds"))) {
#   UK <- raster::getData("GADM", country = "GBR", level = 1)
#   system("mv gadm36_GBR_1_sp.rds Data/gadm36_GBR_1_sp.rds")
# } else {
UK <- readRDS(here(data_dir, "gadm36_GBR_1_sp.rds"))
# }
EW <- subset(UK, NAME_1 %in% c("England", "Wales"))
EW <- fortify(EW)

## map of gauging station locations
gaugingstations_p <- ggplot() + 
  geom_polygon(data = EW, aes(x = long, y = lat, group = group),
               colour = "black", fill = "white") +
  coord_map() +
  geom_point(data = stn_locs, aes(x = long, y = lat, group = group), 
             pch = 20, colour = "blue", size = 5) +
  geom_label_repel(data = stn_locs, 
                  aes(x = long, y = lat, label = RiverName), 
                  size = 5, family = "Times New Roman",
                  max.overlaps = 50) +
  xlab("Longitude") +
  ylab("Latitude") + 
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "gauging-station-locations.pdf"), 
            width = 7, height = 10)
  print(gaugingstations_p)
  dev.off()
  jpeg(here("plots", "gauging-station-locations.jpg"), 
       res = 300, width = (480 * 5), height = (480 * 7))
  print(gaugingstations_p)
  dev.off()
}


# date rounding for simplicity --------------------------------------------

## rename SeasonMid to SeasonMidDate
dat_sub$SeasonMidDate <- dat_sub$SeasonMid

## round SeasonMid date to nearest month
dat_sub$SeasonMid <- round_date(dat_sub$SeasonMid, unit = "month")

# Early season mean flow and cv -------------------------------------------

# *	Mean and CV of river water flow from the beginning of the
#   river-specific fishing season until the end of May in each year 
#   in each river
#   .	Symbol: mnEarlyflow & cvEarlyflow
#   .	Concept: 
#   .	Expectation: 
#   .	Transform: 
#   .	Parameterisation: 

## get dates
d <- dat_sub[, .(date = seq.Date(SeasonStart, SeasonMid, by = "days")), 
             list(RiverName, SeasonStart, SeasonMid)][, c("SeasonStart", "SeasonMid") := NULL]

## get flows
f <- flow_dat[d, on = c("RiverName", "date")]

## calculate variables
foo <- f[, .(mnEarlyflow = mean(flow_std),
             cvEarlyflow = sd(flow_std) / mean(flow_std)),
         list(RiverName, Year)]

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, foo[, list(mykey, mnEarlyflow, cvEarlyflow)], 
                 by = "mykey", all = TRUE)
dat_sub[, mykey := NULL]

# Late season mean flow and cv --------------------------------------------

# *	Mean and CV of river water flow from the middle of the
#   river-specific fishing season until its end in each year 
#   in each river
#   .	Symbol: mnLateflow & cvLateflow
#   .	Concept: 
#   .	Expectation: 
#   .	Transform: 
#   .	Parameterisation: 

## get dates
d <- dat_sub[, .(date = seq.Date(SeasonMid, SeasonEnd, by = "days")), 
             list(RiverName, SeasonMid, SeasonEnd)][, c("SeasonMid", "SeasonEnd") := NULL]

## get flows
f <- flow_dat[d, on = c("RiverName", "date")]

## calculate variables
foo <- f[, .(mnLateflow = mean(flow_std),
             cvLateflow = sd(flow_std) / mean(flow_std)),
         list(RiverName, Year)]

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, foo[, list(mykey, mnLateflow, cvLateflow)], 
                 by = "mykey", all = TRUE)
dat_sub[, mykey := NULL]

# All season mean flow and cv ---------------------------------------------

# *	Mean and CV of river water flow for the whole river-specific 
#   fishing season until the end of May in each year 
#   in each river
#   .	Symbol: mnflow & cvflow
#   .	Concept: 
#   .	Expectation: 
#   .	Transform: 
#   .	Parameterisation: 

## get dates
d <- dat_sub[, .(date = seq.Date(SeasonStart, SeasonEnd, by = "days")), 
             list(RiverName, SeasonStart, SeasonEnd)][, c("SeasonStart", "SeasonEnd") := NULL]

## get flows
f <- flow_dat[d, on = c("RiverName", "date")]

## calculate variables
foo <- f[, .(mnflow = mean(flow_std),
             cvflow = sd(flow_std) / mean(flow_std)),
         list(RiverName, Year)]

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, foo[, list(mykey, mnflow, cvflow)], 
                 by = "mykey", all = TRUE)
dat_sub[, mykey := NULL]

# River type --------------------------------------------------------------

# *	A binary variable describing whether the river is a chalk stream
#   or rain-fed river based on Base Flow Index; see
#   https://nrfa.ceh.ac.uk/derived-flow-statistics
#   . Symbol: RiverType
#   . Concept: Captures differences in salmon susceptibility to
#              angling in two main river types
#   . Expectation: ??
#   . Transform: none
#   . Parameterisation: categorical

## get details of stns
idx <- match(stn_locs$id, stn_cat$id)
stn_meta <- data.frame(stn_cat[idx, ])

## add RiverName
stn_meta$RiverName <- sort(unique(dat_sub$RiverName))

## identify RSE rivers
stn_meta$isRSE <- factor(stn_meta$RiverName %in% rse_rivers)

## plot
bfi_p <- ggplot(stn_meta, 
                aes(x = river, y = bfihost, label = RiverName)) + 
  geom_label(aes(fill = isRSE)) + 
  scale_x_discrete(labels = NULL, breaks = FALSE, 
                   expand = c(0.1, 0.1)) +
  xlab("River") + 
  ylab("Base Flow Index") +
  geom_hline(yintercept = 0.7, linetype = "dashed") + 
  scale_fill_manual(values = setNames(c("white", "gray"),
                                      levels(stn_meta$isRSE))) +
  theme(legend.position = "none") + 
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "base-flow-indexes.pdf"), 
            width = 7, height = 7)
  print(bfi_p)
  dev.off()
  jpeg(here("plots", "base-flow-indexes.jpg"), 
       res = 300, width = (480 * 5), height = (480 * 5))
  print(bfi_p)
  dev.off()
}

## add rename bfi column
stn_meta$BaseFlowIdx <- stn_meta$bfihost

## allocate using cutoff of 0.7
bfi_cut <- 0.7
stn_meta$RiverType <- factor(ifelse(stn_meta$bfihost > bfi_cut, "Chalk", "Spate"))

## merge in 
dat_sub <- merge(dat_sub, 
                 stn_meta[, c("RiverName", "BaseFlowIdx", "RiverType")], 
                 by = "RiverName", all = TRUE)


# save stuff --------------------------------------------------------------

## write out dat_sub
f_nm <- paste0("all-vars-for-analysis.RData")
save(dat_sub, file = here(data_dir, f_nm))

## write out stn_meta
save(x = stn_meta, file = here(data_dir, "gauging-station-metadata.RData"))

