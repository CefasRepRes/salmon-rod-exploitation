# model validation script -------------------------------------------------

## a script `sourced` by the .Rmd to validate the model.


# info --------------------------------------------------------------------

## use changelog
# snippet changelog

## use snippets for todos
# snippet todo-bug
# snippet todo-check-me
# snippet todo-document-me
# snippet todo-fix-me
# snippet todo-optimise-me
# snippet todo-test-me

# use snippets for code chunks
# snippet saveplot
# snippet loadlatestdata


# change log --------------------------------------------------------------

## changelog


# additional libraries ----------------------------------------------------


# additional setup --------------------------------------------------------


# data --------------------------------------------------------------------

## read data
load(here("results", "rod-exploitation-fitting-results.RData"))


# refit best model --------------------------------------------------------
## https://future.futureverse.org/articles/future-4-non-exportable-objects.html

## refit
best_fit <- brm(best_fit$formula,
                data = dat_sub_rse,
                family = beta_binomial2,
                prior = prs_lst[[best_model]],
                chains = 1,
                save_pars = save_pars(all = TRUE),
                control = list(adapt_delta = 0.99))


# k-fold cross validation -------------------------------------------------

## use default 10 folds, stratified over groups approximately evenly
cv_res <- kfold(best_fit, folds = "stratified", group = "RiverName",
                save_fits = TRUE, chains = 1)

## get predictions from the posteriors
cv_pred <- kfold_predict(cv_res)

## add to data
cv_pred_dt <- data.table(dat_sub_rse[, .(RiverName, Year, SalCatch)],
                         t(apply(cv_pred$yrep, 2, 
                                 quantile, c(0.025, 0.5, 0.975))))

## plot it
cv_pred_p <- ggplot(cv_pred_dt, aes(x = as.numeric(as.character(Year)), 
                                    group = 1)) +
  geom_ribbon(aes(y = `50%`, ymin = `2.5%`, ymax = `97.5%`), 
              fill = "lightgrey") +
  geom_line(aes(y = `50%`), colour = "darkgrey") +
  geom_point(aes(y = SalCatch)) +
  facet_wrap(~ RiverName, scales = "free_y") + 
  labs(x = "Year", y = "Declared salmon catch") +
  sgg(tfs = 16, lfs = 16)


# posterior predictive checks ---------------------------------------------

## make plot
pp_check_p <- pp_check(best_fit) + sgg(tfs = 16, lfs = 16)


# save plots --------------------------------------------------------------

## get plot objects
p_objs <- c("cv_pred_p", "pp_check_p")

## make plots in a loop
if (make_plots) {
  for (p in p_objs) {
    
    ### file name
    f_nm <- paste0("dat-", gsub("_", "-", p), "lot")
    
    ### pdf
    cairo_pdf(here("plots", paste0(f_nm, ".pdf")),
              width = 10, height = 7)
    print(eval(as.name(p)))
    dev.off()
    
    ### jpg
    jpeg(here("plots", paste0(f_nm, ".jpg")),
         res = 600, width = (480 * 10), height = (480 * 7))
    print(eval(as.name(p)))
    dev.off()
    
  }
}


# save --------------------------------------------------------------------

## save list
save_lst <- c(
  
  ### cv objects & plot
  "cv_res", # cv results
  "cv_pred", "cv_pred_dt", # cv predictions
  "cv_pred_p", # cv prediction plot
  
  ### pp checks
  "pp_check_p",
  
  ### model & data
  "dat_sub_rse", # data
  "best_fit" # best fit
  
)

## save image
if (save_it) {
  fle_nm <- paste0("rod-exploitation-validation-results.RData")
  save(list = save_lst, file = here("results", fle_nm))
}
