# libraries
library(ggplot2)
library(extrafont)
library(ggrepel) # for non-overlapping plot labels
library(latex2exp) # for TeX
library(rnrfa) # for access to NRFA data and functions, incl osg_parse
library(data.table) # for catch data
library(lubridate)
library(fasttime)
library(sp)
library(raster) # for getData
library(plotrix) # for std.error
library(patchwork)
library(brms)
# brms options
options(brms.backend = "rstan") # expose_functions() does not work with cmdstanr - see https://github.com/paul-buerkner/brms/issues/1176, but threading does not work with rstan.

# ggplot style
sgg <- function(tfs = 16, lfs = 16) {
  theme(text = element_text(family = "Times New Roman", size = tfs),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        strip.text.x = element_text(size = lfs),
        axis.text = element_text(size = lfs),
        axis.title = element_text(size = tfs),
        legend.title = element_text(size = tfs),
        legend.text = element_text(size = tfs),
        complete = FALSE)
}

# default ggplot colours - specify n
ggplotColours <- function(n = 6, h = c(0, 360) + 15){
  if ((diff(h) %% 360) < 1) h[2] <- h[2] - 360/n
  hcl(h = (seq(h[1], h[2], length = n)), c = 100, l = 65)
}

# from https://github.com/paul-buerkner/custom-brms-families/blob/master/families/beta_binomial2.R

## "stan_funs", "stanvars", # additional stan funs
stan_funs <- "
  real beta_binomial2_lpmf(int y, real mu, real phi, int T) {
    return beta_binomial_lpmf(y | T, mu * phi, (1 - mu) * phi);
  }
  int beta_binomial2_rng(real mu, real phi, int T) {
    return beta_binomial_rng(T, mu * phi, (1 - mu) * phi);
  }
"
stanvars <- stanvar(scode = stan_funs, block = "functions")

## "log_lik_beta_binomial2", # custom ll
log_lik_beta_binomial2 <- function(i, prep) {
  mu <- brms::get_dpar(prep, "mu", i = i)
  phi <- brms::get_dpar(prep, "phi", i = i)
  trials <- prep$data$vint1[i]
  y <- prep$data$Y[i]
  beta_binomial2_lpmf(y, mu, phi, trials)
}

## "posterior_predict_beta_binomial2", # associated predictions
posterior_predict_beta_binomial2 <- function(i, prep, ...) {
  mu <- brms::get_dpar(prep, "mu", i = i)
  phi <- brms::get_dpar(prep, "phi", i = i)
  trials <- prep$data$vint1[i]
  beta_binomial2_rng(mu, phi, trials)
}

## "posterior_epred_beta_binomial2", # associated expectations
posterior_epred_beta_binomial2 <- function(prep) {
  mu <- brms::get_dpar(prep, "mu")
  trials <- prep$data$vint1
  trials <- matrix(trials, nrow = nrow(mu), ncol = ncol(mu), byrow = TRUE)
  mu * trials
}

## "beta_binomial2_lpmf", # associated lpmf
beta_binomial2_lpmf <- "
  real beta_binomial2_lpmf(int y, real mu, real phi, int T) {
    return beta_binomial_lpmf(y | T, mu * phi, (1 - mu) * phi);
  }
  int beta_binomial2_rng(real mu, real phi, int T) {
    return beta_binomial_rng(T, mu * phi, (1 - mu) * phi);
  }
"
