# model inferences script -------------------------------------------------

## a script `sourced` by the .Rmd to do inference from model.


# info --------------------------------------------------------------------

## use changelog
# snippet changelog

## use snippets for todos
# snippet todo-bug
# snippet todo-check-me
# snippet todo-document-me
# snippet todo-fix-me
# snippet todo-optimise-me
# snippet todo-test-me

# use snippets for code chunks
# snippet saveplot
# snippet loadlatestdata


# change log --------------------------------------------------------------

## changelog

##! CHANGE LOG: (20221103 11:07:21) used q50 quantiles in place of means
##! CHANGE LOG: (20221103 11:07:45) modified coefficient plot for saturated model

# additional libraries ----------------------------------------------------


# additional setup --------------------------------------------------------


# data --------------------------------------------------------------------

## read data
load(here("Results", "rod-exploitation-fitting-results.RData"))


# fitted values -----------------------------------------------------------

## fit fits
fit_n <- fitted(best_fit, resp = "n", probs = c(0.025, 0.5, 0.975))
fit_mu <- fitted(best_fit, dpar = "mu", probs = c(0.025, 0.5, 0.975))

## add fitted y and fitted ur to d
dat_sub_rse$fitted_SalCatch <- fit_n[, "Q50"]
dat_sub_rse$fitted_SalCatch_lci <- fit_n[, "Q2.5"]
dat_sub_rse$fitted_SalCatch_uci <- fit_n[, "Q97.5"]
dat_sub_rse$fitted_ur <- fit_mu[, "Q50"]
dat_sub_rse$fitted_ur_lci <- fit_mu[, "Q2.5"]
dat_sub_rse$fitted_ur_uci <- fit_mu[, "Q97.5"]


# fixed coefficients ------------------------------------------------------

## get coefficient estimates
coef_ests <- data.table(fixef(res_lst$saturated), keep.rownames = TRUE)

## add name
coef_ests$name <- gsub("poly|2rawEQTRUE|1", "", coef_ests$rn)
coef_ests$name <- gsub("DeclSalEffHa_std2", "I(DeclSalEffHa_std^2)",
                       coef_ests$name)
coef_ests$name <- gsub("DeclSalEff_std2", "I(DeclSalEff_std^2)",
                       coef_ests$name)

## add human-readable name
coef_ests$hr_name <- gsub("_std", "", coef_ests$name)
for (i in 1:length(cont_vars)) {
  n <- grep(cont_vars[i], coef_ests$hr_name)
  coef_ests$hr_name[n] <- gsub(cont_vars[i], cont_nms[i], coef_ests$hr_name[n])
}

## fix factor
coef_ests$hr_name <- factor(coef_ests$hr_name, levels = rev(coef_ests$hr_name))


# random coefficients -----------------------------------------------------

## get ranef estimates
foo <- lapply(ranef(best_fit), 
              function(v) data.table(v[, , 1], 
                                     keep.rownames = "name"))
ranef_ests <- rbindlist(foo, idcol = "type")

## order
setorder(ranef_ests, type, Estimate)

## change RiverName to River
ranef_ests$type <- gsub("Name", "", ranef_ests$type)

## fix factor
ranef_ests$type <- factor(ranef_ests$type, 
                          levels = unique(ranef_ests$type))


# partial effects ---------------------------------------------------------

## get marginal effects
marg_effs <- conditional_effects(best_fit)

## reorder, rename column 1 and convert them to a data.table
o <- c("partial_effect", "effect1__", "estimate__", "lower__", "upper__")
for (i in 1:length(marg_effs)) {
  foo <- marg_effs[[i]]
  colnames(foo)[1] <- "partial_effect"
  foo <- data.table(foo)[, ..o]
  marg_effs[[i]] <- foo 
}

## combine
marg_effs <- rbindlist(marg_effs, id = "variable")

## fix factor
marg_effs$variable <- factor(marg_effs$variable,
                             levels = unique(marg_effs$variable))

## add human-readable name
marg_effs$hr_name <- gsub("_std", "", marg_effs$variable)
for (i in 1:length(cont_vars)) {
  n <- grep(cont_vars[i], marg_effs$hr_name)
  marg_effs$hr_name[n] <- gsub(cont_vars[i], cont_nms[i], marg_effs$hr_name[n])
}

## fix factor
marg_effs$hr_name <- factor(marg_effs$hr_name, levels = cont_nms)


# traces ------------------------------------------------------------------

## get draws for all monitors
foo <- as.data.table(best_fit$fit)

## subset to only _std variables
idx <- grep("_std", colnames(foo))
fii <- foo[, ..idx]

## change column names
c_nms <- colnames(fii)
c_nms <- gsub("b_|poly|2rawEQTRUE|1", "", c_nms)
c_nms <- gsub("DeclSalEffHa_std2", "I(DeclSalEffHa_std^2)",
              c_nms)
c_nms <- gsub("DeclSalEff_std2", "I(DeclSalEff_std^2)",
              c_nms)
colnames(fii) <- c_nms

## make long
coef_traces <- melt(fii, measure.vars = colnames(fii)) 

## add iteration number
coef_traces[, iteration := rep(1:(.N / nchains(best_fit)),
                               nchains(best_fit)), 
            by = variable]

## add chain number
coef_traces[, chain := factor(rep(1:nchains(best_fit),
                                  each = (.N / nchains(best_fit)))), 
            by = variable]


# plots -------------------------------------------------------------------


## fitted
## make data.table with NAs in missing years
foo <- dat_sub_rse[, .(Year = factor(seq(min(as.numeric(as.character(Year))), 
                                         max(as.numeric(as.character(Year)))))), 
                   by = RiverName]
fii <- merge(dat_sub_rse, foo, all = TRUE, sort = FALSE)
exploit_rse_p <- ggplot(fii, 
                        aes(x = Year, group = 1)) + 
  geom_line(aes(y = ur, colour = "1")) + 
  geom_point(aes(y = ur, colour = "1")) + 
  geom_line(aes(y = fitted_ur, colour = "2")) + 
  geom_point(aes(y = fitted_ur, colour = "2")) + 
  geom_errorbar(aes(ymin = fitted_ur_lci, 
                    ymax = fitted_ur_uci,
                    colour = "2")) + 
  facet_wrap(~ RiverName, scale = "free_y") +
  xlab("Year") + 
  ylab("Exploitation rate (SalCatch / RSE)") +
  scale_colour_manual(name = "Type",
                      values = ggplotColours(2),
                      labels = c("Observation", "Estimation")) +
  sgg(tfs = 16, lfs = 16) +
  scale_x_discrete(breaks = c("2000", "2010", "2020")) +
  theme(legend.position = "top")

## fixed coefficients (omitting intercepts)
coef_p <- ggplot(coef_ests[!grepl("Intercept", hr_name), ], 
                 aes(x = hr_name, y = Estimate)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = `Q2.5`, ymax = `Q97.5`), width = 0.25) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  xlab("Coefficient") +
  ylab("Estimate") +
  coord_flip() +
  sgg(tfs = 16, lfs = 16)

## random coefficients
ranef_p <- ggplot(ranef_ests, aes(sample = Estimate)) + 
  geom_text(label = ranef_ests$name, stat = "qq") + 
  stat_qq_line(size = 1.25) + 
  facet_wrap(~ type, scales = "free_y") +
  xlab("Theoretical quantiles") +
  ylab("Sample quantiles") +
  sgg(tfs = 16, lfs = 16)

## marginal effects
me_p <- ggplot(marg_effs, aes(x = partial_effect, y = estimate__)) + 
  geom_ribbon(aes(ymin = lower__, ymax = upper__), alpha = 0.2) + 
  geom_line() + 
  facet_wrap(~ hr_name, scales = "free") +
  xlab("Standardised value") + 
  ylab("Marginal effect") +
  sgg(tfs = 16, lfs = 16)

## traces
trace_p <- ggplot(coef_traces, 
                  aes(x = iteration, y = value, colour = chain)) +
  geom_line() +
  geom_smooth() +
  facet_wrap(~ variable, scales = "free") +
  xlab("Iteration") + 
  ylab("Value") +
  sgg(tfs = 16, lfs = 16)


# save plots --------------------------------------------------------------

## get plot objects
p_objs <- c("exploit_rse_p", "coef_p", "ranef_p", "me_p", "trace_p")

## make plots in a loop
if (make_plots) {
  for (p in p_objs) {
    
    ## file name
    f_nm <- paste0("dat-", gsub("_", "-", p), "lot")
    
    ## pdf
    cairo_pdf(here("plots", paste0(f_nm, ".pdf")),
              width = 10, height = 7)
    print(eval(as.name(p)))
    dev.off()
    
    ## jpg
    jpeg(here("plots", paste0(f_nm, ".jpg")),
         res = 600, width = (480 * 10), height = (480 * 7))
    print(eval(as.name(p)))
    dev.off()
    
  }
}


# save --------------------------------------------------------------------

## save list
save_lst <- c(
  
  ### data objects
  "dat_sub_rse", # data with fits added
  "coef_ests", # fixed coefficient estimates
  "ranef_ests", # random coefficient estimates
  "marg_effs", # marginal effects estimates
  "coef_traces", # fixed coefficient traces
  
  ### plots
  "exploit_rse_p", # fitted plot
  "coef_p", # coef plot
  "ranef_p", # ranef qqplot
  "me_p", # marginal effects plot
  "trace_p" # coef trace plot
  
)

## save image
if (save_it) {
  fle_nm <- paste0("rod-exploitation-inference-results.RData")
  save(list = save_lst, file = here("results", fle_nm))
}

