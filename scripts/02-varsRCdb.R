# principle salmon river data script --------------------------------------

## a script `sourced` by the .Rmd to run organise the PSR data.


# info --------------------------------------------------------------------

## use changelog
# snippet changelog

## use snippets for todos
# snippet todo-bug
# snippet todo-check-me
# snippet todo-document-me
# snippet todo-fix-me
# snippet todo-optimise-me
# snippet todo-test-me

# use snippets for code chunks
# snippet saveplot
# snippet loadlatestdata


# change log --------------------------------------------------------------

## changelog
##! CHANGE LOG: (20220718 15:48:31) Substituted "Data" in here() for data.dir, and re-ran
##! CHANGE LOG: (20221221 07:52:09) Updated to include newest RF for licence declaration rates
##! CHANGE LOG: (20221221 07:53:34) Added sqrt to dat_sub$DeclSalEff to limit the influence of large effort values, especially on Ehen and Mawddach in 1994


# additional libraries ----------------------------------------------------


# additional setup --------------------------------------------------------


# read and fix data -------------------------------------------------------

## read in processed psr rod catch database
load(here(data_dir, "psr-rod-license-db.RData"))

## fix data: replace RiverName with factor of RiverLabel
dat$RiverName <- factor(dat$RiverLabel)
dat[, RiverLabel := NULL]


# Declared effort ---------------------------------------------------------

## reduce to angler data rather than fish
foo <- dat[!duplicated(dat[, list(RiverName, Year, LicenceID, CatchEffortID)]), ]

## extract the rod effort data per year per river
dat_sub <- foo[, .(DeclEff = sum(TotalFishingDays)), by = list(RiverName, Year)]

## plot
salmon_seatrout_effort_p <- ggplot(dat_sub, aes(x = Year, y = DeclEff)) + 
  geom_point() + 
  geom_line() + 
  facet_wrap(~ RiverName, scales = "free_y") + 
  xlab("Year") +
  ylab("Declared salmon and sea trout effort (days)") + 
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "salmon-seatrout-effort-lineplots.pdf"), 
            width = 16, height = 14)
  print(salmon_seatrout_effort_p)
  dev.off()
  jpeg(here("plots", "salmon-seatrout-effort-lineplots.jpg"), 
       res = 300, width = (480 * 11), height = (480 * 10))
  print(salmon_seatrout_effort_p)
  dev.off()
}


# season dates ------------------------------------------------------------

## create data
foo <- unique(dat[, list(RiverName, Year, 
                         SeasonStart, SeasonMid, SeasonEnd)])

## add DoY for plotting
foo[, c("SeasonStartDoY", 
        "SeasonMidDoY", 
        "SeasonEndDoY") := .(yday(SeasonStart),
                             yday(SeasonMid),
                             yday(SeasonEnd))]

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, foo[, list(mykey, 
                                     SeasonStart, 
                                     SeasonMid, 
                                     SeasonEnd)], 
                 by = "mykey", all = TRUE)
dat_sub[, mykey := NULL]

## plot
salmon_season_p <- ggplot(foo, aes(x = RiverName, y = SeasonMidDoY)) +
  geom_point() +
  geom_pointrange(aes(ymin = SeasonStartDoY, ymax = SeasonEndDoY)) +
  coord_flip() + 
  xlab("River name") +
  ylab("Day of year") + 
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "salmon-season-pointrange.pdf"), 
            width = 16, height = 14)
  print(salmon_season_p)
  dev.off()
  jpeg(here("plots", "salmon-season-pointrange.jpg"), 
       res = 300, width = (480 * 11), height = (480 * 10))
  print(salmon_season_p)
  dev.off()
}


# Declared catch ----------------------------------------------------------

## These data were sent over by the EA (Rob Hillman and 
## Katie Whitlock) in the week beginning the 17th December 2018. 
## On inspection, it seems the "Raw data" sheet it the same between
## regions and so we only need to read in once from one of the
## following xlsx: 
##   "Midlands data_v3.xlsx" (3.8mb)
##   "North East data_v3.xlsx" (4.3mb)
##   "NW data_v3.xlsx" (5.1mb)
##   "Southern data_v2.xlsx" (3.9mb)
##   "SW data_v3.xlsx" (5.6mb)

## numbers of declared salmon caught
foo <- dat[SpeciesID == 1, 
           .(DeclCatch = sum(.N)), by = list(RiverName, Year)]

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, foo[, list(mykey, DeclCatch)], 
                 by = "mykey", all = TRUE)
dat_sub[, mykey := NULL]

## add a zero (0) catch where DeclEff was > 0
dat_sub[DeclEff > 0 & is.na(DeclCatch), DeclCatch := 0]

## plot
salmon_declcatch_p <- ggplot(dat_sub, 
                             aes(x = Year, y = DeclCatch)) + 
  geom_point() + 
  geom_line() + 
  facet_wrap(~ RiverName, scales = "free_y") + 
  xlab("Year") +
  ylab("Declared salmon catch") + 
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "salmon-declcatch-lineplots.pdf"), 
            width = 16, height = 14)
  print(salmon_declcatch_p)
  dev.off()
  jpeg(here("plots", "salmon-declcatch-lineplots.jpg"), 
       res = 300, width = (480 * 11), height = (480 * 10))
  print(salmon_declcatch_p)
  dev.off()
}

## numbers of salmon "caught with effort (cwe)"
foo <- dat[SpeciesID == 1 & TotalFishingDays > 0, 
           .(CatchwEff = sum(.N)), by = list(RiverName, Year)]

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, foo[, list(mykey, CatchwEff)], 
                 by = "mykey", all.x = TRUE)
dat_sub[, mykey := NULL]

## add a zero (0) catch where DeclEff was > 0
dat_sub[DeclEff > 0 & is.na(CatchwEff), CatchwEff := 0]

## plot
salmon_cwe_p <- ggplot(dat_sub, aes(x = Year, y = CatchwEff)) + 
  geom_point() + 
  geom_line() + 
  facet_wrap(~ RiverName, scales = "free_y") + 
  xlab("Year") +
  ylab("Declared salmon catch with declared effort") + 
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "salmon-cwe-lineplots.pdf"), 
            width = 16, height = 14)
  print(salmon_cwe_p)
  dev.off()
  jpeg(here("plots", "salmon-cwe-lineplots.jpg"), 
       res = 300, width = (480 * 11), height = (480 * 10))
  print(salmon_cwe_p)
  dev.off()
}


# Probability of release --------------------------------------------------

## numbers of salmon released and killed
foo <- dat[SpeciesID == 1, 
           .(pRelease = mean(Released)), by = list(RiverName, Year)]

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, foo[, list(mykey, pRelease)], 
                 by = "mykey", all.x = TRUE)
dat_sub[, mykey := NULL]

## when CatchwEff == 0 [n == 42, mostly Stour (SW) and Piddle], 
## then pRelease is the mean of the pRelease in the two latest
## (preferably, preceding) years weighted by DeclCatch in those years
foo <- dat_sub[which(is.na(dat_sub$pRelease)), 
               list(RiverName, Year, pRelease)]
for (i in 1:nrow(foo)) {
  if (foo$RiverName[i] == "Stour (SW)") {
    idx <- which(dat_sub$RiverName == foo$RiverName[i] &
                   dat_sub$Year == foo$Year[i])
    dat_sub[idx, pRelease := 1]
  } else {
    fii <- subset(dat_sub, RiverName == foo$RiverName[i])
    aa <- na.omit(fii)[, Year]
    bb <- sort(aa[aa < foo[i, Year]], decreasing = TRUE)[1:2]
    if (sum(is.na(bb)) == 1) {
      v <- aa[-which(aa %in% na.omit(bb))]
      bb <- c(na.omit(bb), v[which.min(abs(foo[i, Year] - v))])
    }
    idx <- which(dat_sub$RiverName == foo$RiverName[i] & 
                   dat_sub$Year %in% bb)
    mu_p <- weighted.mean(x = dat_sub[idx, pRelease],
                          w = dat_sub[idx, DeclCatch])
    idx <- which(dat_sub$RiverName == foo$RiverName[i] &
                   dat_sub$Year == foo$Year[i])
    dat_sub[idx, pRelease := mu_p]
  }
}

## add nReleased and nKilled
dat_sub$nReleased <- floor(dat_sub$DeclCatch * dat_sub$pRelease)
dat_sub$nKilled <- floor(dat_sub$DeclCatch - dat_sub$nReleased)

## plot
foo <- stack(dat_sub[, list(nReleased, nKilled)])
foo <- cbind(dat_sub[, list(RiverName, Year)], foo)
salmon_fate_p <- ggplot(foo, 
                        aes(x = Year, y = values, colour = ind)) + 
  geom_point() + 
  geom_line() + 
  facet_wrap(~ RiverName, scales = "free_y") + 
  xlab("Year") +
  ylab("Declared salmon fate") + 
  scale_color_discrete(name = "Fate") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "salmon-fate-lineplots.pdf"), 
            width = 16, height = 14)
  print(salmon_fate_p)
  dev.off()
  jpeg(here("plots", "salmon-fate-lineplots.jpg"), 
       res = 300, width = (480 * 11), height = (480 * 10))
  print(salmon_fate_p)
  dev.off()
}


# Declared effort rate ----------------------------------------------------

## add effort declaration rate
dat_sub$DeclEffRate <- dat_sub$DeclCatch / dat_sub$CatchwEff

## if CatchwEff == 0 and DeclCatch == 0, then set DeclEffRate == 1
dat_sub[CatchwEff == 0 & DeclCatch == 0, DeclEffRate := 1]

## if CatchwEff == 0 and DeclCatch > 0, then set DeclEffRate == 0
dat_sub[CatchwEff == 0 & DeclCatch > 0, DeclEffRate := 0]


# Reported salmon effort rate ---------------------------------------------

## read data
foo <- data.frame(read_xls(here(data_dir, "pSL_effort1_sg.xls"), 
                           sheet = "SL_ST effort_All rivers", 
                           range = "C5:P75", 
                           .name_repair = "minimal"))

## add colnames
colnames(foo) <- c("Catchment", "Days_Salmon", "Days_Seatrout",
                   "Total_days",
                   "perc_Salmon", "perc_Seatrout",
                   "V1", "V2",
                   "Catchment", 
                   "Days_Salmon", "Days_Seatrout", "Total_days",
                   "perc_Salmon", "perc_Seatrout")

## remove subtotals
foo <- foo[-grep("Total", foo$Catchment), ]

## reshape
psaleff <- rbind(foo[, c(1:6)], foo[, c(9:14)])

## add year
psaleff$Year <- rep(c(1992, 2006), each = nrow(foo))

## fix Catchment names
psaleff <- subset(psaleff, Catchment %in% dat_sub$RiverName)

## add RiverName factor
psaleff$RiverName <- factor(psaleff$Catchment)

## convert to data.table
foo <- data.table(psaleff)

## average 1992 and 2006 survey results
foo <- foo[, .(RepSalEffRate = mean(perc_Salmon, na.rm = TRUE) / 100), 
           by = list(RiverName)]

## add in "Stour (SW)" and set as same as "Frome"
fii <- data.table(RiverName = "Stour (SW)", 
                  RepSalEffRate = foo[RiverName == "Frome", RepSalEffRate])
foo <- rbind(foo, fii)

## merge in
dat_sub <- merge(dat_sub, foo[, list(RiverName, RepSalEffRate)], 
                 by = "RiverName", all = TRUE)

## plot
psaleff_lplot <- ggplot(psaleff, 
                        aes(x = Year, y = perc_Salmon, col = RiverName)) + 
  geom_point(size = 3) + 
  geom_line(linetype = "dashed") +
  xlab("Year") +
  ylab("Proportion of declared effort for salmon") +
  scale_color_discrete(name = "River\nname") +
  scale_x_continuous(breaks = sort(unique(psaleff$Year)), 
                     labels = sort(unique(psaleff$Year))) +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "psaleff-lineplots.pdf"), 
            width = 7, height = 7)
  print(psaleff_lplot)
  dev.off()
  jpeg(here("plots", "psaleff-lineplots.jpg"), 
       res = 300, width = (480 * 7), height = (480 * 7))
  print(psaleff_lplot)
  dev.off()
}


# Licence declaration rate ------------------------------------------------

## read licence declaration rates
ldr <- read_xlsx(here(data_dir, "Rod catch_Raising Factors_to 2018_2_SG1.xlsx"), 
                 sheet = "RF_All rivers", range = "A1:Y65")

## convert to data.table
ldr <- data.table(ldr)

## reshape
foo <- melt(ldr[, -1], 
            id.vars = c("River"), 
            measure.vars = grep("^RF_", colnames(ldr[, -1])))

## extract and add year
foo[, "Year" := lapply(strsplit(as.character(foo$variable), split = "_"), 
                       "[[", 3)]

## remove years from variable
foo[, "variable" := gsub("[\\_]+{1}[0-9]{4}", "", variable)]

## column names
setnames(foo, colnames(foo), c("RiverName", "Variable", "LicDeclRate", "Year"))

## reduce foo to only "RF_All_Revised" and remove variable
foo <- foo[Variable == "RF_All_Revised", ][, Variable := NULL]

## fix river names
foo$RiverName <- gsub("-([A-z]*)", " (\\1)", foo$RiverName)
foo[RiverName == "Duddon ( and Lickle)", RiverName := "Duddon (& Lickle)"]
foo[RiverName == "Dyfi", RiverName := "Dyfi / Dovey"]
foo[RiverName == "E&W Cleddau", RiverName := "Cleddau"]
foo[RiverName == "Eden", RiverName := "Eden (NW)"]
foo[RiverName == "Esk", RiverName := "Esk (Cumbrian)"]
foo[RiverName == "Esk (Yorks)", RiverName := "Esk (Yorkshire)"]
foo[RiverName == "Tywi", RiverName := "Tywi / Towy"]
foo[RiverName == "Wyre", RiverName := "Wyre (NW)"]

## factorize
foo$Year <- factor(foo$Year, yrs)
foo$RiverName <- factor(foo$RiverName, ps_rivers)

## expand to all years
foo <- foo[data.table(expand.grid(Year = levels(foo$Year),
                                  RiverName = levels(foo$RiverName))), 
           on = c("Year", "RiverName")]

## ensure order
setorder(foo, "Year", "RiverName")

## longer-term owners data rivers
owner_rivers <- c("Wye", "Test", "Itchen", "Avon (Hants)")

## read longer-term owners data
fii <- lapply(owner_rivers, function(v) 
  read_xlsx(here(data_dir, "Rod catch_Raising Factors_to 2018_2_SG1.xlsx"), 
            sheet = paste(as.character(v), "owners returns")))
fii <- data.table(do.call("rbind", fii))

# ## remove rows with missing owners data
# fii <- fii[-which(is.na(fii$Rods_Owners_SL)), ]

## replace any values < 1.0 with 1.0
fii[which(`Owner/Declared_SL` < 1.0), `Owner/Declared_SL` := 1]

## reorganise columns
fii[, c("RiverName", "LicDeclRate") := list(River, `Owner/Declared_SL`)]

## remove columns
idx <- grep(paste0(colnames(foo), collapse = "$|"), colnames(fii))
fii <- fii[, ..idx]

## factorize
fii$Year <- factor(fii$Year, yrs)
fii$RiverName <- factor(fii$RiverName, ps_rivers)

## remove NAs, e.g., owner data reported that is not in `yrs`
fii <- na.omit(fii)

## ensure order
setorder(fii, "Year", "RiverName")

## loop over owner_rivers
for (r in owner_rivers) {
  foo[RiverName == r & Year %in% yrs, "LicDeclRate"] <- fii[RiverName == r & Year %in% yrs, LicDeclRate]
}

## replace NA in LicDeclRate with 1.1
foo[is.na(LicDeclRate), LicDeclRate := 1.1]

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, foo[, list(mykey, LicDeclRate)], 
                 by = "mykey", all.x = TRUE)
dat_sub[, mykey := NULL]


# Fishery area ------------------------------------------------------------

## add area
dat_sub <- merge(dat_sub, unique(dat[, list(RiverName, area)]), 
                 by = "RiverName", all = TRUE)

## rename
dat_sub[, AreaHA := area]
dat_sub[, area := NULL]


# Counter river RSE -------------------------------------------------------

## read first column of data for year info
colA <- read_xlsx(here(data_dir, "T23 & F28.xlsx"), 
                  sheet = "T23", 
                  range = cell_cols("A"),
                  col_names = FALSE)

## get cell range
rng <- paste0("D", which(colA == as.character(yrs[1])), 
              ":S", which(colA == as.character(rev(yrs)[1])))

## use rng to get RSE data  
counter_rse <- read_xlsx(here(data_dir, "T23 & F28.xlsx"), 
                         sheet = "T23", 
                         range = rng,
                         col_names = FALSE,
                         col_types = "numeric") # produces lots of NAs - a good thing!

## specify correct river names
hdr <- c("Tyne", NA, NA, "Test", "Itchen", "Avon (Hants)", "Frome",
         "Tamar", "Fowey", "Lune", "Kent", "Leven", NA, "Dee", "Teifi")

## reduce counter_rse to only those rivers
counter_rse <- counter_rse[, which(!is.na(hdr))]

## use correct river names
colnames(counter_rse) <- na.omit(hdr)

## add years to counter_rse
counter_rse$Year <- yrs

## reshape wide to long
counter_rse <- melt(data.table(counter_rse), id.vars = "Year", 
                    variable.name = "RiverName", value.name = "RSE")

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
counter_rse[, mykey := do.call(paste, c(.SD, sep = "_")), 
            .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, counter_rse[, list(mykey, RSE)],
                 by = "mykey", all.x = TRUE)
dat_sub[, mykey := NULL]


# Angler effort -----------------------------------------------------------

# * Number of declared days fished for salmon in each river in each
#   year (salmon and sea trout effort is split based on 1992 and 2006
#   questionnaires to licence holders)
#   .	Symbol: DeclaredEffort
#   .	Concept: Measures fishing effort for salmon in a fishery
#   .	Expectation: Rod exploitation will be positively related to
#                  DeclaredEffort because more days fishing should
#                  yield more catches, although this might only be
#                  true until a threshold beyond which the yield
#                  asymptotes as the remaining fish become too
#                  difficult to capture. However, DeclaredEffort 
#                  is anticipated to have declined over time 
#   .	Transform: none
#   .	Parameterisation: linear and quadratic
#   .	Note: the ICD method standardises effort by dividing it 
#           by Fishery size – see below; we could do this here  

## apply effort corrections 
dat_sub$DeclSalEff <- with(dat_sub, floor(DeclEff * DeclEffRate * (RepSalEffRate * LicDeclRate)))

## plot
salmon_eff_p <- ggplot(dat_sub, 
                       aes(x = Year, y = DeclSalEff, colour = RiverName)) + 
  geom_line(size = 1.25) +
  geom_point(size = 2) +
  xlab("Year") +
  ylab("log10(effort)") +
  scale_y_log10() + 
  theme(legend.position = "bottom") +
  scale_color_discrete(name = "River\nname") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "salmon-effort-lineplots.pdf"), 
            width = 12, height = 10)
  print(salmon_eff_p)
  dev.off()
  jpeg(here("plots", "salmon-effort-lineplots.jpg"), 
       res = 300, width = (480 * 8), height = (480 * 7))
  print(salmon_eff_p)
  dev.off()
}

## add effort standardised by area
# dat_sub$DeclSalEffHa <- dat_sub$DeclSalEff / dat_sub$AreaHA # - no Ehen & Mawddach
# dat_sub$DeclSalEffHa <- (dat_sub$DeclSalEff / 100) / dat_sub$AreaHA # - no Ehen & Mawddach
# dat_sub$DeclSalEffHa <- sqrt(dat_sub$DeclSalEff) / dat_sub$AreaHA # - large uncertainty
# dat_sub$DeclSalEffHa <- log(dat_sub$DeclSalEff + 1) / dat_sub$AreaHA # - no Dwyryd & large uncertainty
dat_sub$DeclSalEffHa <- sqrt(dat_sub$DeclSalEff) / log(dat_sub$AreaHA)

## plot
salmon_effha_p <- ggplot(dat_sub, aes(x = Year, y = DeclSalEffHa, colour = RiverName)) + 
  geom_line(size = 1.25) +
  geom_point(size = 2) +
  xlab("Year") +
  ylab("Effort per hectare") +
  theme(legend.position = "bottom") +
  scale_color_discrete(name = "River\nname") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "salmon-effort-area-lineplots.pdf"), 
            width = 12, height = 10)
  print(salmon_effha_p)
  dev.off()
  jpeg(here("plots", "salmon-effort-area-lineplots.jpg"), 
       res = 300, width = (480 * 8), height = (480 * 7))
  print(salmon_effha_p)
  dev.off()
}

## add salmon catch
dat_sub$SalCatch <- floor(dat_sub$DeclCatch * dat_sub$LicDeclRate)

## plot
salmon_catch_p <- ggplot(dat_sub, 
                         aes(x = Year, y = SalCatch, colour = RiverName)) + 
  geom_line(size = 1.25) +
  geom_point(size = 2) +
  xlab("Year") +
  ylab("Salmon catch") +
  theme(legend.position = "bottom") +
  scale_color_discrete(name = "River\nname") +
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "salmon-catch-lineplots.pdf"), 
            width = 12, height = 10)
  print(salmon_catch_p)
  dev.off()
  jpeg(here("plots", "salmon-catch-lineplots.jpg"), 
       res = 300, width = (480 * 8), height = (480 * 7))
  print(salmon_catch_p)
  dev.off()
}


# Successful effort -------------------------------------------------------

# *	Proportion of declared days fished for which no salmonid was 
#   caught in each river in each year
#   .	Symbol: SuccessEff
#   .	Concept: Measures how catchable salmonids are in a particular 
#              fishery
#   .	Expectation: Rod exploitation will be positively related to
#                  SuccessEff because anglers will visit 
#                  fisheries where the yield:effort ratio is high
#   .	Transform: none
#   .	Parameterisation: linear

## annual, river-specific catch effort ID
idx <- do.call("paste0", dat[, list(Year, RiverName, CatchEffortID)])

## create simplified database
fii <- dat[!duplicated(idx), ]

## sum TotalFishingDays in each catchment & year
successful_effort <- fii[, 
                         .(Total = sum(TotalFishingDays)), 
                         by = list(RiverName, Year)]

## sum TotalFishingDays with catch in each catchment & year
foo <- fii[SpeciesID == 1, 
           .(Count = sum(TotalFishingDays)), 
           by = list(RiverName, Year)]

## merge them
successful_effort[, mykey := do.call(paste, c(.SD, sep = "_")), 
                  .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
successful_effort <- merge(successful_effort, foo[, list(mykey, Count)], 
                           by = "mykey", all = TRUE)
successful_effort[, mykey := NULL]

## calculate Successful_effort
successful_effort[, SuccessEff := Count / Total]
foo <- successful_effort

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, foo[, list(mykey, nSuccessDays = Count, SuccessEff)], 
                 by = "mykey", all = TRUE)
dat_sub[, mykey := NULL]

## correct any NAs for when a fish was caught for every day fished
idx <- which(is.na(dat_sub$SuccessEff))
dat_sub$nSuccessDays[idx] <- 0
dat_sub$SuccessEff[idx] <- 0


# Fishing method ----------------------------------------------------------

# *	% total declared salmon caught in each river in each year that
#   were caught by [Fly/Spinner/Bait/Undeclared/combination]
#   .	Symbol: FishingMethod
#   .	Concept: Measures salmon capture rates by [method] in a fishery
#   .	Expectation: ??  
#   .	Transform: arcsine / none
#   .	Parameterisation: linear

# Method_ID   Method_Type
# 1           Fly
# 2           Spinner
# 3           Bait
# 4           Unknown

## calculate min and max doy and count for each Method in each catchment and year
salmon_method <- dat[SpeciesID == 1, .(Count = .N), 
                     by = list(RiverName, Year, Method)]

## calculate proportion of N caught by each method, removing "Unknown"
salmon_method <- salmon_method[, 
                               .(Count = sum(Count)), 
                               by = .(RiverName, Year, Method)][Method != "Unknown", 
                                                                Prop := Count/sum(Count), 
                                                                by = .(RiverName, Year)]

## add other methods into salmon_method
foo <- data.table(expand.grid("RiverName" = levels(dat$RiverName),
                              "Year" = sort(unique(dat$Year)),
                              "Method" = c("Fly", "Bait", "Spinner")))
salmon_method <- salmon_method[foo, on = colnames(foo)]

## add a zero for count
salmon_method[is.na(Count), Count := 0]

## add a zero for proportion when at least 1 fish was caught, otherwise NA
salmon_method[, Tot := sum(Count), by = .(RiverName, Year)]
idx <- which(salmon_method$Tot > 0 & is.na(salmon_method$Prop))
salmon_method[idx, "Prop"] <- 0
salmon_method[, Tot := NULL]

## get only comparison method, here fly fishing
foo <- subset(salmon_method, Method == "Fly")

## write table of years with no catch and so no CapMethod
fii <- foo[is.na(Prop), ]
setorder(fii, "RiverName", "Year")
write.csv(x = fii, file = here(data_dir, "capMethod-missing-river-years.csv"), 
          row.names = FALSE)

## rename Prop to CapMethod
foo[, CapMethod := Prop]

## merge in
dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
        .SDcols = c("RiverName", "Year")]
foo[, mykey := do.call(paste, c(.SD, sep = "_")), 
    .SDcols = c("RiverName", "Year")]
dat_sub <- merge(dat_sub, foo[, list(mykey, CapMethod)], 
                 by = "mykey", all = TRUE)
dat_sub[, mykey := NULL]

## plot them
salmon_method_p <- ggplot(dat_sub, aes(x = Year, y = CapMethod)) +
  geom_point() + 
  geom_line() + 
  facet_wrap(~ RiverName, scales = "free_y") +
  xlab("Year") +
  ylab("Proportion of declared salmon catch caught by fly") + 
  sgg(tfs = 16, lfs = 16)
if (make_plots) {
  cairo_pdf(here("plots", "salmon-method-lineplots.pdf"), 
            width = 16, height = 14)
  print(salmon_method_p)
  dev.off()
  jpeg(here("plots", "salmon-method-lineplots.jpg"), 
       res = 300, width = (480 * 11), height = (480 * 10))
  print(salmon_method_p)
  dev.off()
}


# Dominant Sea Winter age ---------------------------------------------

#   # * Binary variable indicating whether the fishery is dominated by 
#   #   MSW or 1SW salmon
#   #   .	Symbol: DominantSW
#   #   .	Concept: Variable to allow differing effect of early and late 
#   #              season pulses on exploitation rate depending on the
#   #              dominant perceived sea-age composition of the fishery
#   #              over time.
#   #   .	Expectation: DominantSW will affect rod exploitation 
#   #                  through its interaction with flow – see Early
#   #                  and late season pulses
#   #   .	Transform: none
#   #   .	Parameterisation: binary
#   
# 	## date of 1SW entry into river
#   D1SW <- as.Date("2010-09-01")
#   
#   ## add beforeD1SW variable
#   dat$beforeD1SW <- as.numeric(dat$CaptureDoY < yday(D1SW))
#   
#   ## make counts
#   foo <- dat[SpeciesID == 1, 
#              .(y = .N), by = list(RiverName, Year, beforeD1SW)]
#   
#   ## make variable
#   fii <- foo[, .(DominantSW = beforeD1SW[which.max(y)]), 
#              list(RiverName, Year)]
#   fii$DominantSW <- factor(fii$DominantSW, 
#                              levels = c(0, 1),
#                              labels = c("1SW", "MSW"))
#   
#   ## merge with foo
#   dat_sub[, mykey := do.call(paste, c(.SD, sep = "_")), 
#           .SDcols = c("RiverName", "Year")]
#   fii[, mykey := do.call(paste, c(.SD, sep = "_")), 
#       .SDcols = c("RiverName", "Year")]
#   dat_sub <- merge(dat_sub, fii[, list(mykey, DominantSW)], 
#                    by = "mykey", all = TRUE)
#   dat_sub[, mykey := NULL]


# calculate response var --------------------------------------------------

## add log10ur_rse
dat_sub$ur_rse <- (dat_sub$SalCatch / dat_sub$RSE) * 100
dat_sub$log10ur_rse <- log(dat_sub$ur_rse, 10)


# save stuff --------------------------------------------------------------

## write out dat_sub
f_nm <- paste0("rcdb-vars-for-analysis.RData")
save(dat_sub, file = here(data_dir, f_nm))
